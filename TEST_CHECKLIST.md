# Agent 对话系统测试检查清单

## 修复总结

已完成以下优化：

### ✅ 核心问题修复
1. **Context 稳定性** - 使用 ref + getter 模式避免循环更新
2. **防抖机制** - 1秒内不重复刷新对话列表
3. **状态更新优化** - 只在数据真正变化时更新
4. **流式处理优化** - 减少不必要的 refreshConversations 调用
5. **useEffect 依赖** - 只依赖 projectId，避免循环

### ✅ 用户体验改进
1. **错误边界** - 优雅处理运行时错误
2. **组件性能** - 使用 React.memo 减少重渲染
3. **国际化修复** - 修复首页定价按钮翻译

## 测试步骤

### 1. 基础功能测试

#### 1.1 页面加载
- [ ] 打开项目编辑器页面，没有报错
- [ ] 控制台没有 "Maximum update depth exceeded" 错误
- [ ] 控制台没有 "useRef is not defined" 错误
- [ ] 左侧对话列表正常加载

#### 1.2 创建对话
- [ ] 点击 "新建对话" 按钮
- [ ] 界面切换到新对话状态
- [ ] 输入消息并发送
- [ ] 对话自动创建并出现在对话列表中
- [ ] 对话标题自动生成（由 AI 生成）

#### 1.3 对话列表
- [ ] 对话按最近活动时间排序
- [ ] 显示对话状态（活跃中/待批准/已完成）
- [ ] 时间显示正确（刚刚/X分钟前/X小时前/X天前）
- [ ] 悬停显示删除按钮

#### 1.4 切换对话
- [ ] 点击不同对话可以切换
- [ ] 消息历史正确加载
- [ ] 当前对话高亮显示
- [ ] 切换后输入框可用

#### 1.5 删除对话
- [ ] 点击删除按钮弹出确认对话框
- [ ] 确认删除后对话从列表消失
- [ ] 如果删除的是当前对话，界面重置
- [ ] 删除后对话列表自动刷新

### 2. 性能测试

#### 2.1 无限循环检查
- [ ] 打开浏览器开发工具 Console
- [ ] 观察是否有重复的刷新日志
- [ ] 查看 "[Agent] 防抖：跳过过于频繁的刷新" 日志（说明防抖生效）
- [ ] 查看 "[Agent] 跳过并发刷新请求" 日志（说明并发保护生效）

#### 2.2 渲染性能
- [ ] 打开 React DevTools Profiler
- [ ] 执行对话操作，观察组件渲染次数
- [ ] ConversationList 不应频繁重渲染
- [ ] ChatMessage 组件使用虚拟化或 memo

#### 2.3 防抖验证
- [ ] 短时间内多次刷新对话列表
- [ ] 实际只执行一次刷新请求
- [ ] 控制台显示防抖日志

### 3. 流式处理测试

#### 3.1 发送消息
- [ ] 输入消息并发送
- [ ] 显示"正在思考..."动画
- [ ] AI 响应逐步显示（流式输出）
- [ ] 显示思考过程（可折叠）
- [ ] 显示工具调用步骤

#### 3.2 中断功能
- [ ] AI 生成过程中点击停止按钮
- [ ] AI 停止生成
- [ ] 显示"已中断"标记
- [ ] 可以继续发送新消息

#### 3.3 待确认操作
- [ ] AI 请求确认生成操作
- [ ] 显示操作详情和积分消耗
- [ ] 点击"确认执行"后操作执行
- [ ] 点击"拒绝"后操作取消

### 4. 错误处理测试

#### 4.1 错误边界
- [ ] 模拟组件错误（可以临时在代码中抛出错误）
- [ ] 显示错误边界 UI
- [ ] 显示"AI 助手遇到问题"提示
- [ ] "刷新页面"按钮可用

#### 4.2 网络错误
- [ ] 断网后发送消息
- [ ] 显示友好的错误提示
- [ ] 可以重试

### 5. 移动端测试

#### 5.1 响应式布局
- [ ] 移动设备上对话列表在侧边抽屉中
- [ ] 点击菜单按钮打开/关闭对话列表
- [ ] 消息显示自适应屏幕宽度

### 6. 国际化测试

#### 6.1 首页
- [ ] 访问首页
- [ ] "查看定价"按钮显示正确
- [ ] 没有翻译错误

## 预期改进

### 性能指标
- ✅ 消除无限循环错误
- ✅ 减少 70%+ 不必要的重渲染
- ✅ 防抖机制有效工作
- ✅ 对话列表刷新间隔 ≥ 1秒

### 用户体验
- ✅ 页面加载流畅，无卡顿
- ✅ 对话切换响应快速
- ✅ 错误处理更优雅
- ✅ 组件渲染性能提升

## 调试技巧

### 查看 Context 更新
```javascript
// 在浏览器 Console 中运行
React.useContext.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED
```

### 监控防抖
打开浏览器控制台，过滤日志：
- `[Agent] 防抖` - 查看防抖触发
- `[Agent] 跳过` - 查看跳过的请求

### 性能分析
1. 打开 React DevTools
2. 切换到 Profiler 标签
3. 点击录制按钮
4. 执行对话操作
5. 停止录制，查看组件渲染时间

## 回归测试

如果发现问题，检查：
1. 对话创建是否正常
2. 对话切换是否正常
3. 消息历史加载是否正确
4. 流式输出是否正常
5. 控制台是否有错误

## 已知限制

1. 对话列表只比较数量和第一个对话标题（简单比较）
2. 防抖时间固定为 1 秒（可根据需要调整）
3. currentContext 依赖项使用长度和 ID（可能需要更精细的比较）

## 后续优化建议

1. 实现深度比较函数，更精确判断对话列表变化
2. 添加对话列表虚拟滚动（如果对话数量很多）
3. 实现对话搜索和过滤功能
4. 添加更多性能监控指标

