# Agent å¯ç¼–è¾‘å‚æ•°åŠŸèƒ½ - å®ç°æ–‡æ¡£

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·ç°åœ¨å¯ä»¥åœ¨ Agent ç¡®è®¤é¢æ¿ä¸­**ç›´æ¥ç¼–è¾‘**æ‰€æœ‰ function call çš„å‚æ•°ï¼ŒAgent æˆä¸ºç”Ÿæˆå›¾ç‰‡å’Œè§†é¢‘çš„**ç»Ÿä¸€å…¥å£**ã€‚

## ğŸ”„ å®Œæ•´æµç¨‹

```
ç”¨æˆ· â†’ Agentå¯¹è¯ 
   â†’ Agent åˆ†ææ„å›¾å¹¶è°ƒç”¨ function 
   â†’ **æ˜¾ç¤ºå¯ç¼–è¾‘å‚æ•°é¢æ¿** 
   â†’ ç”¨æˆ·æŸ¥çœ‹/ç¼–è¾‘å‚æ•° 
   â†’ ç”¨æˆ·ç¡®è®¤ 
   â†’ åç«¯ä½¿ç”¨ä¿®æ”¹åçš„å‚æ•°æ‰§è¡Œ
```

## âœ¨ æ ¸å¿ƒæ”¹åŠ¨

### 1. åç«¯ Engine æ”¯æŒå‚æ•°è¦†ç›–

**æ–‡ä»¶**: `src/lib/services/agent-engine/engine.ts`

```typescript
async *resumeConversation(
  conversationId: string,
  approved: boolean,
  modifiedParams?: Record<string, unknown> // ğŸ†• æ–°å¢å‚æ•°
)
```

- æ¥å—ç”¨æˆ·ä¿®æ”¹çš„å‚æ•°
- è¦†ç›–åŸå§‹ tool call çš„ arguments
- æ›´æ–°æ¶ˆæ¯å†å²ä¸­çš„å‚æ•°

### 2. API è·¯ç”±ä¼ é€’å‚æ•°

**æ–‡ä»¶**: `src/app/api/agent/stream/route.ts`

```typescript
resumeValue?: {
  approved: boolean;
  modifiedParams?: Record<string, unknown>; // ğŸ†•
}
```

### 3. å‰ç«¯ Hook ä¼ é€’å‚æ•°

**æ–‡ä»¶**: `src/components/projects/editor/agent-panel/use-agent-stream.tsx`

```typescript
const resumeConversation = useCallback(
  async (
    conversationId: string, 
    approved: boolean, 
    modifiedParams?: Record<string, unknown> // ğŸ†•
  )
)
```

### 4. ç¡®è®¤é€»è¾‘ä¼ é€’å‚æ•°

**æ–‡ä»¶**: `src/components/projects/editor/agent-panel/chat-message.tsx`

```typescript
const handleConfirmAction = async (modifiedParams?: Record<string, unknown>) => {
  await resumeConversation(
    agent.state.currentConversationId, 
    true, 
    modifiedParams // ğŸ†• ä¼ é€’ä¿®æ”¹çš„å‚æ•°
  );
}
```

### 5. å¯ç¼–è¾‘å‚æ•°é¢æ¿

**æ–‡ä»¶**: `src/components/projects/editor/agent-panel/pending-action-message.tsx`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… ç¼–è¾‘/æŸ¥çœ‹æ¨¡å¼åˆ‡æ¢
- âœ… å›¾ç‰‡ç”Ÿæˆå‚æ•°å¯ç¼–è¾‘ï¼ˆpromptã€nameã€tagsï¼‰
- âœ… è§†é¢‘ç”Ÿæˆå‚æ•°å¯ç¼–è¾‘ï¼ˆpromptã€titleã€durationã€aspect_ratioï¼‰
- âœ… ä¿®æ”¹åçš„å‚æ•°ä¼ é€’ç»™ç¡®è®¤å›è°ƒ

**UI ç‰¹æ€§**:
- é»˜è®¤ä¸º**æŸ¥çœ‹æ¨¡å¼**ï¼ˆåªè¯»ï¼‰
- ç‚¹å‡»"ç¼–è¾‘å‚æ•°"è¿›å…¥ç¼–è¾‘æ¨¡å¼
- ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºå®Œæ•´è¡¨å•ï¼ˆInputã€Textareaã€Selectï¼‰
- ç‚¹å‡»"å®Œæˆç¼–è¾‘"ä¿å­˜ä¿®æ”¹
- ç‚¹å‡»"ç¡®è®¤æ‰§è¡Œ"æ—¶è‡ªåŠ¨ä½¿ç”¨ä¿®æ”¹åçš„å‚æ•°

## ğŸ¨ ç”¨æˆ·ä½“éªŒ

### å›¾ç‰‡ç”Ÿæˆç¤ºä¾‹

**Agent**: "å¥½çš„ï¼Œæˆ‘å°†ä¸ºä½ ç”Ÿæˆ3ä¸ªè§’è‰²å›¾ç‰‡"

**ç”¨æˆ·çœ‹åˆ°**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¨ ç”Ÿæˆå›¾ç‰‡èµ„äº§                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å¡ç‰‡1]                             â”‚
â”‚ åç§°: ä¸»è§’-å¼ ä¸‰                      â”‚
â”‚ æç¤ºè¯: A young warrior in...       â”‚
â”‚ æ ‡ç­¾: è§’è‰², ä¸»è§’, ç”·æ€§               â”‚
â”‚                                     â”‚
â”‚ [å¡ç‰‡2] [å¡ç‰‡3]                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ç¼–è¾‘å‚æ•°] æŒ‰é’®                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’° æ€»æ¶ˆè€—: 30 ç§¯åˆ†                  â”‚
â”‚ [å–æ¶ˆ] [ç¡®è®¤æ‰§è¡Œ]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‚¹å‡»"ç¼–è¾‘å‚æ•°"å**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¨ ç”Ÿæˆå›¾ç‰‡èµ„äº§                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å¡ç‰‡1 - ç¼–è¾‘æ¨¡å¼]                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ â”‚ åç§°: [å¯ç¼–è¾‘è¾“å…¥æ¡†]  â”‚            â”‚
â”‚ â”‚ æç¤ºè¯: [å¯ç¼–è¾‘æ–‡æœ¬åŸŸ]â”‚            â”‚
â”‚ â”‚ æ ‡ç­¾: [å¯ç¼–è¾‘è¾“å…¥æ¡†]  â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [âœ“ å®Œæˆç¼–è¾‘] æŒ‰é’®                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’° æ€»æ¶ˆè€—: 30 ç§¯åˆ†                  â”‚
â”‚ [å–æ¶ˆ] [ç¡®è®¤æ‰§è¡Œ]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§†é¢‘ç”Ÿæˆç¤ºä¾‹

**å¯ç¼–è¾‘å­—æ®µ**:
- æç¤ºè¯ï¼ˆTextareaï¼‰
- æ ‡é¢˜ï¼ˆInputï¼‰
- æ—¶é•¿ï¼ˆSelect: 5ç§’/10ç§’ï¼‰
- å®½é«˜æ¯”ï¼ˆSelect: 16:9/9:16/1:1ï¼‰

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å‚æ•°ä¼ é€’é“¾è·¯

```
ç”¨æˆ·ç¼–è¾‘ 
  â†’ editedParams (React state)
  â†’ onConfirm(id, editedParams)
  â†’ handleConfirmAction(modifiedParams)
  â†’ resumeConversation(conversationId, true, modifiedParams)
  â†’ API: /api/agent/stream (POST)
  â†’ Engine.resumeConversation(conversationId, approved, modifiedParams)
  â†’ è¦†ç›– tool call arguments
  â†’ executeFunction with modified params
```

### å…³é”®çŠ¶æ€ç®¡ç†

```typescript
// PendingActionMessage.tsx
const [isEditing, setIsEditing] = useState(false);
const [editedParams, setEditedParams] = useState(functionCall.arguments);

// ä¿®æ”¹å‚æ•°
setEditedParams({ ...editedParams, prompt: newValue });

// ä¼ é€’ç»™ç¡®è®¤
onConfirm(functionCall.id, isEditing ? editedParams : undefined);
```

## ğŸ“Š ä¼˜åŠ¿æ€»ç»“

1. âœ… **ç»Ÿä¸€å…¥å£**: Agent æˆä¸ºå”¯ä¸€çš„åˆ›ä½œå…¥å£
2. âœ… **AI è¾…åŠ©**: Agent å¸®ç”¨æˆ·é¢„å¡« 80% çš„å‚æ•°
3. âœ… **ç”¨æˆ·æ§åˆ¶**: ç”¨æˆ·ä¿ç•™å®Œå…¨æ§åˆ¶æƒï¼Œå¯éšæ—¶è°ƒæ•´
4. âœ… **å‡å°‘ç»´æŠ¤**: ä¸å†éœ€è¦ç‹¬ç«‹çš„ UI ç”Ÿæˆé¢æ¿
5. âœ… **æ›´å¥½å¼•å¯¼**: æ–°ç”¨æˆ·é€šè¿‡å¯¹è¯å­¦ä¹ ï¼Œä¸“ä¸šç”¨æˆ·å¿«é€Ÿç¼–è¾‘

## ğŸ§ª æµ‹è¯•æ¸…å•

### å›¾ç‰‡ç”Ÿæˆæµ‹è¯•
- [ ] Agent æå‡ºç”Ÿæˆå›¾ç‰‡
- [ ] ç¡®è®¤é¢æ¿æ˜¾ç¤ºå‚æ•°
- [ ] ç‚¹å‡»"ç¼–è¾‘å‚æ•°"è¿›å…¥ç¼–è¾‘æ¨¡å¼
- [ ] ä¿®æ”¹ prompt
- [ ] ä¿®æ”¹ name
- [ ] ä¿®æ”¹ tags
- [ ] ç‚¹å‡»"å®Œæˆç¼–è¾‘"
- [ ] ç‚¹å‡»"ç¡®è®¤æ‰§è¡Œ"
- [ ] åç«¯æ”¶åˆ°ä¿®æ”¹åçš„å‚æ•°
- [ ] å›¾ç‰‡ç”ŸæˆæˆåŠŸ

### è§†é¢‘ç”Ÿæˆæµ‹è¯•
- [ ] Agent æå‡ºç”Ÿæˆè§†é¢‘
- [ ] ç¡®è®¤é¢æ¿æ˜¾ç¤ºå‚æ•°
- [ ] ç‚¹å‡»"ç¼–è¾‘å‚æ•°"
- [ ] ä¿®æ”¹ prompt
- [ ] ä¿®æ”¹ duration
- [ ] ä¿®æ”¹ aspect_ratio
- [ ] ç¡®è®¤æ‰§è¡Œ
- [ ] è§†é¢‘ç”ŸæˆæˆåŠŸ

### è¾¹ç•Œæƒ…å†µæµ‹è¯•
- [ ] ä¸ç¼–è¾‘ç›´æ¥ç¡®è®¤ï¼ˆä½¿ç”¨åŸå§‹å‚æ•°ï¼‰
- [ ] ç¼–è¾‘åç‚¹å‡»å–æ¶ˆ
- [ ] ç¼–è¾‘ä¸€åŠåˆ‡æ¢åˆ°å¦ä¸€æ¡æ¶ˆæ¯
- [ ] ç§¯åˆ†ä¸è¶³æ—¶çš„æç¤º

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **é«˜çº§å‚æ•°æŠ˜å **: å°†æ¬¡è¦å‚æ•°ï¼ˆaspectRatioã€resolutionï¼‰æŠ˜å åˆ°"é«˜çº§é€‰é¡¹"ä¸­
2. **å‚æ•°éªŒè¯**: åœ¨å‰ç«¯æ·»åŠ å®æ—¶éªŒè¯ï¼ˆprompt ä¸èƒ½ä¸ºç©ºç­‰ï¼‰
3. **å‚æ•°é¢„è®¾**: æ·»åŠ å¸¸ç”¨å‚æ•°é¢„è®¾ï¼ˆå¦‚"é«˜è´¨é‡è§’è‰²å›¾"ã€"åœºæ™¯å…¨æ™¯"ç­‰ï¼‰
4. **å¿«æ·é”®**: æ”¯æŒ `E` é”®å¿«é€Ÿè¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œ`Enter` ç¡®è®¤
5. **å‚æ•°å†å²**: è®°ä½ç”¨æˆ·åå¥½çš„å‚æ•°è®¾ç½®
6. **AI æ¨èæ ‡è¯†**: ç”¨è§†è§‰æ ‡è¯†åŒºåˆ† AI ç”Ÿæˆçš„å‚æ•°å’Œç”¨æˆ·ä¿®æ”¹çš„å‚æ•°

## ğŸ“ ä»£ç æ”¹åŠ¨æ–‡ä»¶åˆ—è¡¨

- âœ… `src/lib/services/agent-engine/engine.ts` - Engine æ”¯æŒå‚æ•°è¦†ç›–
- âœ… `src/app/api/agent/stream/route.ts` - API è·¯ç”±ä¼ é€’å‚æ•°
- âœ… `src/components/projects/editor/agent-panel/use-agent-stream.tsx` - Hook ä¼ é€’å‚æ•°
- âœ… `src/components/projects/editor/agent-panel/chat-message.tsx` - ç¡®è®¤é€»è¾‘ä¼ é€’å‚æ•°
- âœ… `src/components/projects/editor/agent-panel/pending-action-message.tsx` - å¯ç¼–è¾‘ UI

## ğŸ‰ å®ŒæˆçŠ¶æ€

**æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼**

ç”¨æˆ·ç°åœ¨å¯ä»¥ï¼š
1. é€šè¿‡å¯¹è¯è®© Agent ç”Ÿæˆå›¾ç‰‡/è§†é¢‘
2. åœ¨ç¡®è®¤é¢æ¿æŸ¥çœ‹ Agent å¡«å¥½çš„å‚æ•°
3. ç‚¹å‡»"ç¼–è¾‘å‚æ•°"æŒ‰é’®è¿›è¡Œä¿®æ”¹
4. ä¿®æ”¹ä»»ä½•å‚æ•°ï¼ˆpromptã€åç§°ã€æ ‡ç­¾ã€æ—¶é•¿ã€å®½é«˜æ¯”ç­‰ï¼‰
5. ç¡®è®¤åä½¿ç”¨ä¿®æ”¹çš„å‚æ•°æ‰§è¡Œä»»åŠ¡

**Agent å·²æˆä¸ºç»Ÿä¸€çš„åˆ›ä½œå…¥å£ï¼** ğŸš€


