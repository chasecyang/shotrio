# 视频生成参数展示 - 测试指南

## 功能概述

实现了在Agent确认卡片中以用户可读的方式展示 `generate_shot_video` 函数的Kling O1视频生成参数。

## 实现的功能

### 1. 参数格式化器 (`src/lib/utils/agent-params-formatter.ts`)

新增了以下功能：

- `KlingO1ConfigDisplay` 接口：定义配置展示结构
- `PromptPart` 接口：定义Prompt解析结果
- `parsePromptReferences()`: 解析Prompt中的 `@label` 引用
- `extractImagesFromKlingO1Config()`: 从配置中提取所有图片
- `formatKlingO1ConfigSync()`: 格式化完整配置为展示结构

### 2. UI组件 (`src/components/projects/editor/agent-panel/pending-action-message.tsx`)

新增了以下组件：

- `PromptWithHighlights`: 高亮显示Prompt中的 `@label` 引用
- `ImageThumbnail`: 显示图片缩略图，带类型标识和标签
- `ParamItem`: 通用参数项展示
- `KlingO1ConfigDisplay`: 主展示组件，整合所有子组件

### 3. 展示内容

- **运动描述**: 完整的prompt，`@label` 占位符高亮显示
- **关联图片**: 横向滚动列表，显示所有图片缩略图及标签
  - 类型标识：角色、起始帧、参考
  - 标签名称：从配置中解析或使用默认名称
- **其他参数**: 时长和宽高比

## 测试场景

### 场景1：基本配置（只有prompt和duration）

**测试步骤**：
1. 在Agent中输入："为第一个分镜生成视频"
2. AI应该调用 `generate_shot_video` 并提供基本配置
3. 确认卡片应显示：
   - 运动描述（prompt）
   - 时长（默认5秒或指定值）
   - 宽高比（默认16:9）

**预期结果**：
- Prompt区域显示完整描述
- 没有图片列表（如果没有elements或image_urls）
- 参数区域显示时长和宽高比

### 场景2：包含起始帧

**测试步骤**：
1. 在分镜编辑器中为分镜添加一张图片，标签设为"首帧"
2. 在Agent中输入："使用首帧生成这个分镜的视频"
3. AI应该在 `klingO1Config.image_urls` 中包含这张图片

**预期结果**：
- 关联图片区域显示1张图片
- 图片类型标识为"起始帧"
- 标签显示"首帧"或"起始帧"

### 场景3：包含角色元素

**测试步骤**：
1. 为分镜添加角色图片，标签如"汤姆-主图"、"汤姆-动作参考"
2. 在Agent中请求生成视频
3. AI应该将这些图片组织到 `klingO1Config.elements`

**预期结果**：
- 关联图片区域显示多张图片
- 每张图片类型标识为"角色"
- 标签显示原始label（如"汤姆-主图"）

### 场景4：复杂配置（多张图片 + @label引用）

**测试步骤**：
1. 为分镜添加多种类型的图片：首帧、角色、场景等
2. 在Agent中请求生成视频
3. Prompt应包含 `@label` 引用

**预期结果**：
- Prompt中的 `@首帧`、`@汤姆-主图` 等被高亮显示
- 关联图片区域以横向滚动显示所有图片
- 每张图片正确显示类型标识和标签
- 可以横向滚动查看所有图片

### 场景5：图片加载失败

**测试步骤**：
1. 模拟图片URL无效的情况
2. 触发视频生成

**预期结果**：
- 图片缩略图显示默认图标（ImageIcon）
- 不会导致整个UI崩溃
- 标签仍然正常显示

### 场景6：超长Prompt

**测试步骤**：
1. 提供一个非常详细的运动描述
2. 触发视频生成

**预期结果**：
- Prompt区域有最大高度限制（max-h-32）
- 内容可以上下滚动
- 不会撑大整个确认卡片

### 场景7：没有图片的配置

**测试步骤**：
1. 创建一个只有prompt的配置
2. 触发视频生成

**预期结果**：
- 只显示运动描述和参数区域
- 关联图片区域不显示（条件渲染）
- UI保持紧凑美观

## 视觉检查

### 样式检查
- [ ] Prompt高亮颜色清晰可见
- [ ] 图片缩略图大小合适（80px宽度）
- [ ] 类型标识图标清晰可辨
- [ ] 标签文字不会溢出
- [ ] 横向滚动平滑自然
- [ ] 整体配色与现有UI一致

### 响应式检查
- [ ] 在小屏幕上正常显示
- [ ] 图片滚动条在需要时出现
- [ ] Prompt区域在内容过长时可滚动
- [ ] 参数网格在窄屏上正常布局

### 交互检查
- [ ] 鼠标悬停在标签上显示完整文本（title属性）
- [ ] 滚动条样式符合设计规范
- [ ] 图片加载状态合理

## 边界情况

### 1. 空配置
```json
{
  "klingO1Config": {}
}
```
**预期**：显示默认值（5秒、16:9），prompt为空时显示空白

### 2. 最多图片（7张）
```json
{
  "klingO1Config": {
    "elements": [
      {
        "frontal_image_url": "...",
        "reference_image_urls": ["...", "..."]
      }
    ],
    "image_urls": ["...", "...", "...", "..."]
  }
}
```
**预期**：所有7张图片都能正确显示和滚动

### 3. 特殊字符的label
```
@汤姆-主图、@Scene_01、@角色-1
```
**预期**：正则表达式正确匹配中文、字母、数字、连字符、下划线

### 4. 配置解析失败
**预期**：Fallback到标准参数格式化，不会导致崩溃

## 性能考虑

- ✅ 使用 `useMemo` 缓存格式化结果
- ✅ 图片懒加载（Next.js Image组件自带）
- ✅ 条件渲染避免不必要的DOM节点
- ✅ 使用 CSS 滚动条而不是 JS 实现

## 可访问性

- ✅ 图片alt属性包含label
- ✅ 类型标识有对应的文本标签
- ✅ 标签truncate时提供title属性
- ✅ 颜色对比度符合WCAG标准（primary背景 + primary文字）

## 后续优化建议

1. **URL到label映射**：目前使用默认标签，未来可以从数据库查询shotAssets获取真实标签
2. **图片预览**：Hover到 `@label` 时显示对应图片的浮动预览
3. **编辑功能**：允许用户在确认前调整图片顺序或移除图片
4. **模板保存**：保存常用配置作为模板
5. **对比视图**：如果多次生成，显示配置差异

## 已知限制

1. **URL映射**：当前实现不查询数据库，图片标签可能不完全准确（使用默认值）
2. **国际化**：类型标识和部分文本尚未使用i18n
3. **图片总数限制**：UI层面没有强制7张限制（由API层面控制）

## 回归测试

确认此修改不影响其他功能：

- [ ] `generate_assets` 确认卡片正常
- [ ] `create_shots` 确认卡片正常
- [ ] `update_shots` 确认卡片正常
- [ ] 其他function的确认卡片正常
- [ ] 标准参数格式化仍然工作

---

**测试完成标准**：
- 所有测试场景通过
- 视觉检查通过
- 响应式检查通过
- 边界情况处理正确
- 回归测试通过

