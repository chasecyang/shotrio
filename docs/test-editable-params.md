# Agent 可编辑参数功能 - 测试指南

## 🧪 测试步骤

### 准备工作

1. 确保开发环境正常运行
2. 登录系统
3. 创建或打开一个项目
4. 打开 Agent 面板

---

## 测试1: 图片生成 - 完整编辑流程

### 步骤

1. **发起对话**
   ```
   用户输入: "帮我生成一个武侠风格的主角"
   ```

2. **观察 Agent 响应**
   - ✅ Agent 分析意图
   - ✅ Agent 调用 `generate_image_asset` function
   - ✅ 显示确认面板

3. **检查确认面板**
   - ✅ 显示生成的参数（name、prompt、tags）
   - ✅ 显示积分消耗
   - ✅ 有"编辑参数"按钮
   - ✅ 有"取消"和"确认执行"按钮

4. **进入编辑模式**
   - 点击"编辑参数"按钮
   - ✅ 界面切换到编辑模式
   - ✅ 所有参数变为可编辑表单

5. **修改参数**
   - 修改名称: `武侠主角-张三丰`
   - 修改提示词: 在原有基础上添加 `wearing white robes`
   - 修改标签: 添加 `武当派`
   - ✅ 修改实时生效

6. **保存编辑**
   - 点击"完成编辑"按钮
   - ✅ 界面切换回查看模式
   - ✅ 显示修改后的参数

7. **确认执行**
   - 点击"确认执行"按钮
   - ✅ Toast 提示"操作已确认"
   - ✅ Agent 开始执行
   - ✅ 显示"正在创作..."

8. **验证结果**
   - 打开浏览器 DevTools → Network
   - 查找 `/api/agent/stream` 请求
   - 检查 Request Payload:
     ```json
     {
       "resumeConversationId": "...",
       "resumeValue": {
         "approved": true,
         "modifiedParams": {
           "assets": [{
             "name": "武侠主角-张三丰",
             "prompt": "...wearing white robes",
             "tags": ["角色", "主角", "武当派"]
           }]
         }
       }
     }
     ```
   - ✅ `modifiedParams` 包含修改后的值

9. **检查生成结果**
   - 等待任务完成
   - ✅ 资产库中出现新图片
   - ✅ 图片名称是修改后的值
   - ✅ 标签正确

---

## 测试2: 不编辑直接确认

### 步骤

1. **发起对话**
   ```
   用户输入: "生成一个森林场景"
   ```

2. **观察确认面板**
   - ✅ 显示 Agent 生成的参数

3. **不编辑，直接确认**
   - 不点击"编辑参数"
   - 直接点击"确认执行"
   - ✅ 使用 Agent 原始参数执行

4. **验证请求**
   - 检查 Request Payload:
     ```json
     {
       "resumeConversationId": "...",
       "resumeValue": {
         "approved": true
         // ✅ 没有 modifiedParams
       }
     }
     ```

---

## 测试3: 视频生成 - 参数编辑

### 步骤

1. **发起对话**
   ```
   用户输入: "用这两张图生成一个视频"
   （假设项目中已有图片素材）
   ```

2. **观察确认面板**
   - ✅ 显示视频生成参数
   - ✅ 显示起始帧预览

3. **进入编辑模式**
   - 点击"编辑参数"
   - ✅ 看到可编辑表单

4. **修改视频参数**
   - 修改提示词: 添加更多镜头描述
   - 修改时长: 从 5秒 → 10秒
   - 修改宽高比: 从 16:9 → 9:16
   - ✅ Select 组件正常工作

5. **确认执行**
   - 点击"完成编辑"
   - 点击"确认执行"
   - ✅ 修改后的参数传递到后端

6. **验证结果**
   - ✅ 视频任务创建成功
   - ✅ 使用修改后的参数（10秒、9:16）

---

## 测试4: 边界情况

### 4.1 积分不足

1. 确保账户积分 < 所需积分
2. Agent 提出生成请求
3. ✅ 显示积分不足警告
4. ✅ "确认执行"按钮禁用
5. ✅ 显示"充值"按钮

### 4.2 编辑后取消

1. Agent 提出请求
2. 进入编辑模式
3. 修改一些参数
4. 点击"取消"按钮
5. ✅ Agent 收到拒绝消息
6. ✅ 可以继续对话

### 4.3 多个资产批量生成

1. **发起对话**
   ```
   用户输入: "生成3个不同表情的角色"
   ```
2. ✅ 显示3个资产卡片
3. 进入编辑模式
4. ✅ 每个卡片都可以独立编辑
5. 修改第2个卡片的 prompt
6. 确认执行
7. ✅ 所有资产生成，第2个使用修改后的 prompt

---

## 测试5: 后端日志验证

### 查看 Console 日志

启动开发服务器后，执行上述测试，观察控制台日志：

```bash
# 用户确认时的日志
[AgentEngine] 恢复对话: xxx, 批准: true 使用修改后的参数

# 参数覆盖的日志
[AgentEngine] 使用用户修改的参数: { assets: [...] }
```

✅ 确认日志显示正确

---

## 🎯 预期结果总结

### 功能正常标准

- ✅ 参数面板默认为查看模式
- ✅ "编辑参数"按钮可见且可点击
- ✅ 点击后所有参数变为可编辑表单
- ✅ 修改参数实时生效
- ✅ "完成编辑"保存修改
- ✅ "确认执行"时传递修改的参数
- ✅ 后端接收并使用修改的参数
- ✅ 任务执行结果符合修改后的参数
- ✅ 不编辑时使用原始参数
- ✅ 取消操作正常工作

### 性能要求

- 编辑模式切换 < 100ms
- 参数修改无延迟
- 确认执行响应 < 500ms

### UI/UX 要求

- 编辑按钮位置明显
- 表单布局清晰
- 必填字段有提示
- 加载状态有反馈

---

## 🐛 已知问题（如有）

（目前无已知问题）

---

## ✅ 测试完成标准

所有上述测试用例通过 = **功能完全可用** 🎉

---

## 📞 遇到问题？

如果测试中遇到问题：

1. 检查浏览器 Console 是否有错误
2. 检查 Network 请求是否正确发送
3. 检查服务器日志是否有报错
4. 确认数据库连接正常
5. 确认环境变量配置正确





