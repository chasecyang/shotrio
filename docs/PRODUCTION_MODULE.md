# 成片模块 (Production Timeline)

## 概述

成片模块是 Cineqo 的核心功能之一，提供类似专业剪辑软件的时间轴界面，用于将分镜图转换为视频并最终导出成片。

## 功能特性

### ✅ 已实现（MVP版本）

#### 1. 时间轴展示
- **水平时间刻度**：按秒显示，支持缩放（50%-500%）
- **视频轨道**：显示所有分镜片段，长度对应duration
- **音频轨道**：显示对话的音频波形占位
- **字幕轨道**：显示对话文本和时间范围
- **播放头**：实时显示当前播放位置

#### 2. 分镜列表面板
- **缩略图展示**：左侧垂直列表显示所有分镜
- **多选支持**：Checkbox多选或Shift+点击
- **状态可视化**：
  - 🟢 已生成视频
  - 🟡 有图片待生成
  - ⚫ 无图片
- **右键菜单**：生成视频、重新生成（待实现）

#### 3. 视频生成工作流
- **选择性生成**：可选择单个或多个分镜批量生成
- **智能提示词**：根据运镜类型自动生成Kling Video API的prompt
- **后台处理**：使用Job系统，支持并发控制（默认3个）
- **实时反馈**：通过SSE推送任务进度
- **自动刷新**：生成完成后自动更新时间轴

#### 4. 预览播放
- **视频播放器**：支持播放/暂停、进度条、音量控制
- **时间码显示**：格式化显示当前时间和总时长
- **分镜信息**：叠加显示分镜编号和描述

#### 5. 基础导出
- **快速预览**：前端串联播放所有视频
- **导出任务**：创建Job返回视频列表
- **后续扩展**：支持FFmpeg合成（需要额外实现）

### 🚧 待实现（后续迭代）

#### 拖拽调整
- 拖拽分镜片段调整顺序
- 拖拽片段边缘调整时长

#### 转场效果
- 淡入淡出、溶解、擦除等
- 转场时长可调

#### TTS生成
- 根据对话文本自动生成语音
- 多角色声音区分

#### 音频混合
- BGM轨道
- 音效轨道
- 音量包络线调节

#### 字幕编辑
- 字幕样式自定义
- 字幕位置调整
- 字幕动画效果

## 技术架构

### 前端组件

```
production/
├── production-timeline.tsx       # 核心容器组件
├── timeline-header.tsx           # 顶部工具栏
├── shot-list-panel.tsx          # 左侧分镜列表
├── video-preview-panel.tsx      # 中央预览区
├── timeline-tracks.tsx          # 底部时间轴容器
├── video-track.tsx              # 视频轨道
├── audio-track.tsx              # 音频轨道
└── subtitle-track.tsx           # 字幕轨道
```

### 后端任务

#### 新增Job类型
- `shot_video_generation`: 单镜视频生成
- `batch_video_generation`: 批量视频生成
- `final_video_export`: 最终成片导出
- `shot_tts_generation`: 单镜TTS生成（预留）

#### 数据库扩展
- `shot_transition` 表：存储转场配置
- `jobTypeEnum` 枚举：添加新的任务类型

### API集成

#### Kling Video API
- **模型**：Kling V2.6 Pro
- **输入**：分镜图 + 运动提示词
- **输出**：5秒或10秒视频（自动根据duration选择）
- **特性**：支持原生音频生成

## 使用流程

### 1. 选择剧集
在顶部下拉菜单选择要处理的剧集

### 2. 选择分镜
在左侧列表中勾选需要生成视频的分镜

### 3. 生成视频
点击"生成视频"按钮，系统会：
- 创建批量生成任务
- 为每个分镜创建子任务
- 自动生成运动prompt
- 调用Kling API生成视频
- 上传视频到R2存储
- 更新分镜记录

### 4. 预览成片
- 在时间轴上点击分镜片段
- 中央预览区显示视频
- 使用播放控制查看效果

### 5. 导出成片
点击"导出成片"按钮，系统会：
- 收集所有已生成的视频
- 创建导出任务
- 返回视频列表（当前实现）
- 未来：使用FFmpeg合成最终视频

## 视觉设计

### 配色方案
- **背景**：`#0a0a0b`（极深灰，类似代码编辑器）
- **卡片/轨道**：`#151518`（深灰）
- **边框**：`#1f1f23`, `#2a2a2e`（多层次灰色）
- **高亮**：`#3b82f6` → `#8b5cf6`（蓝紫渐变）
- **状态色**：
  - 生成中：`#f59e0b`（琥珀色）
  - 已完成：`#10b981`（翡翠绿）
  - 失败：`#ef4444`（红色）

### 字体
- **时间码/镜号**：`JetBrains Mono`（等宽字体）
- **正文**：`Inter Variable`（系统默认）

### 动画
- 分镜卡片hover：浮起 + 发光边框
- 播放头：渐变色 + 平滑移动
- 进度条：渐变流动效果

## 性能优化

### 前端
- **虚拟滚动**：处理大量分镜（可选，当前未实现）
- **节流处理**：拖拽和缩放事件
- **懒加载**：缩略图按需加载

### 后端
- **并发控制**：批量生成限制并发数（默认3）
- **队列处理**：使用Job系统异步处理
- **进度推送**：SSE实时反馈任务状态

## 文件清单

### 新建文件
1. 页面：`src/app/[lang]/projects/[id]/production/page.tsx`
2. 组件：`src/components/projects/production/*.tsx`（9个文件）
3. Actions：`src/lib/actions/video/*.ts`（2个文件）
4. Utils：`src/lib/utils/motion-prompt.ts`

### 修改文件
1. `src/lib/db/schemas/project.ts` - 添加转场表和Job类型
2. `src/types/job.ts` - 添加新的Job类型定义
3. `src/lib/workers/job-processor.ts` - 添加视频生成处理逻辑
4. `src/components/projects/layout/project-sidebar.tsx` - 添加成片导航
5. `messages/zh.json` - 添加"成片"翻译

## 后续开发建议

### 短期（1-2周）
1. **完善导出功能**：集成FFmpeg或使用云视频处理服务
2. **添加转场效果**：实现基础的淡入淡出
3. **错误处理优化**：失败重试、断点续传

### 中期（1个月）
1. **TTS集成**：对话文本转语音
2. **拖拽编辑**：分镜顺序调整、时长修改
3. **音频混合**：BGM、音效、音量调节

### 长期（3个月）
1. **关键帧动画**：字幕动画、音量包络线
2. **实时预览**：边编辑边预览
3. **协作功能**：多人同时编辑

## 技术挑战与解决方案

### 挑战1：视频生成时间长
- **问题**：Kling每个5秒视频需要1-2分钟
- **方案**：Job队列后台处理，前端显示进度和预估时间

### 挑战2：大量视频文件存储
- **问题**：视频文件占用存储空间大
- **方案**：使用CDN加速，视频预加载策略，定期清理

### 挑战3：时间轴性能
- **问题**：大量分镜时渲染卡顿
- **方案**：Canvas渲染、虚拟滚动、节流处理

### 挑战4：FFmpeg处理
- **问题**：视频合成需要较强的计算能力
- **方案**：使用云函数或专门的视频处理服务，限制并发数

## 常见问题

### Q: 为什么有些分镜无法生成视频？
A: 分镜必须先有图片才能生成视频。请确保在分镜页面已经生成了分镜图。

### Q: 视频生成需要多长时间？
A: 每个5秒视频大约需要1-2分钟，10秒视频需要2-4分钟。批量生成会并发处理，最多同时3个。

### Q: 导出的成片在哪里？
A: 当前版本导出任务完成后会返回视频列表，您需要在任务中心查看结果。未来版本会直接提供下载链接。

### Q: 时间轴无法滚动？
A: 如果总时长较短，时间轴可能不需要滚动。您可以尝试调整缩放级别（Zoom）来查看更多细节。

### Q: 如何修改分镜顺序？
A: 当前版本需要在分镜页面调整顺序。拖拽功能将在后续版本实现。

## 贡献指南

欢迎贡献代码！请确保：
1. 遵循现有代码风格
2. 添加适当的注释
3. 更新相关文档
4. 测试功能完整性

## 许可证

MIT License
