# 场景提取功能

## 功能概述

场景提取功能允许用户从剧本中自动识别并提取所有拍摄场景，快速建立项目的场景库。该功能参考了角色提取功能的设计，提供了相似的用户体验。

## 功能流程

### 1. 启动场景提取

在场景管理页面，用户可以看到一个醒目的横幅提示，点击"开始提取"按钮即可启动场景提取任务。

- 系统会读取项目中所有剧集的剧本内容
- 提交一个异步后台任务，不阻塞用户操作
- 显示任务进度和状态

### 2. AI 分析与提取

后台 Worker 会调用 OpenAI API 分析剧本内容：

- 识别所有不同的拍摄场景/地点
- 为每个场景生成名称和详细描述
- 场景描述包含：
  - 空间布局特征
  - 环境氛围
  - 关键道具和装饰元素
  - 光线和色调特征

### 3. 预览与编辑

任务完成后，用户可以在对话框中预览提取结果：

- **左侧面板**：场景列表，显示所有提取的场景
  - 新场景标记为"新"
  - 已存在的场景标记为"已存在"
  - 支持全选/取消全选
  
- **右侧面板**：场景详情编辑
  - 场景名称
  - 场景描述（详细的环境描述）
  - 已存在的场景不可编辑

### 4. 确认导入

用户确认后，系统会：

- 跳过已存在的同名场景
- 创建新的场景记录
- 显示导入统计：新增场景数、跳过场景数

## 技术实现

### 文件结构

```
src/
├── types/
│   ├── job.ts                                    # 添加场景提取任务类型
│   └── project.ts                                # 添加场景提取相关类型
├── lib/
│   ├── db/schemas/project.ts                     # 更新任务枚举
│   ├── actions/scene/
│   │   ├── extraction.ts                        # 导入提取的场景
│   │   ├── async-extraction.ts                  # 启动场景提取任务
│   │   └── index.ts                             # 导出所有 actions
│   └── workers/
│       └── job-processor.ts                      # 添加场景提取处理逻辑
└── components/projects/scenes/
    ├── scene-extraction-banner.tsx              # 场景提取横幅
    ├── scene-extraction-dialog.tsx              # 场景提取对话框
    └── scenes-section.tsx                       # 集成提取功能
```

### 核心 API

#### 1. 启动场景提取任务

```typescript
import { startSceneExtraction } from "@/lib/actions/scene";

const result = await startSceneExtraction(projectId);
// Returns: { success: boolean; jobId?: string; error?: string }
```

#### 2. 导入提取的场景

```typescript
import { importExtractedScenes } from "@/lib/actions/scene";

const result = await importExtractedScenes(projectId, scenes);
// Returns: { 
//   success: boolean; 
//   imported?: { newScenes: number; skippedScenes: number }; 
//   error?: string 
// }
```

### AI Prompt 设计

场景提取的 AI Prompt 重点关注：

1. **场景识别**：识别不同的拍摄地点
2. **场景描述**：生成详细的环境描述，适合用于 AI 生成场景图片
3. **去重处理**：相同地点算作一个场景

输出格式：
```json
{
  "scenes": [
    {
      "name": "场景名称",
      "description": "详细的场景描述，包含环境特征、氛围、道具、光线等"
    }
  ]
}
```

## 用户体验优化

### 1. 实时进度反馈

- 横幅显示任务状态（等待、处理中、完成、失败）
- 进度条显示具体进度百分比
- 进度消息说明当前处理步骤

### 2. 智能去重

- 自动识别已存在的同名场景
- 在预览界面明确标记已存在的场景
- 默认只选中新场景，避免重复导入

### 3. 可编辑预览

- 用户可以在导入前修改场景名称和描述
- 分屏布局，左侧列表，右侧详情
- 支持批量选择和编辑

### 4. 自动关闭与刷新

- 导入成功后 3 秒自动关闭对话框
- 自动刷新页面显示新增的场景

## 与角色提取的对比

| 特性 | 角色提取 | 场景提取 |
|------|---------|---------|
| 提取对象 | 主要角色 | 拍摄场景/地点 |
| 子元素 | 角色造型（多个） | 无 |
| 去重策略 | 同名角色合并，添加新造型 | 同名场景跳过 |
| 后续操作 | 生成角色造型图片 | 生成场景视角图片 |
| 提取复杂度 | 高（需要分析造型变化） | 中（主要识别地点） |

## 使用场景

1. **新项目初始化**：快速从剧本建立场景库
2. **剧本更新后**：重新提取，自动跳过已有场景
3. **场景补充**：为遗漏的场景快速补充

## 注意事项

1. 场景提取需要项目中有剧本内容
2. 相同地点的不同时间/天气会被视为同一场景
3. 提取后需要手动为每个场景生成视角参考图
4. 场景描述的质量直接影响后续图片生成效果

## 未来优化方向

- [ ] 支持场景时间/天气等属性的自动提取
- [ ] 提取完成后自动触发场景图片生成
- [ ] 支持场景关系分析（如：室内/室外、主场景/次场景）
- [ ] 提供场景使用频率统计

