# 编辑器剧本提取功能集成

## 概述

将角色提取和场景提取功能集成到编辑器的资源面板中，用户现在可以直接在编辑器中提取角色和场景，无需切换到单独的管理页面。

## 实施日期

2025-12-12

## 修改的文件

### 1. 角色列表组件
**文件**: `src/components/projects/editor/resource-panel/character-list.tsx`

#### 新增功能
- 添加"从剧本提取"按钮（当项目有剧集时显示）
- 集成 `CharacterExtractionBanner` 横幅组件（compact 模式）
- 集成 `CharacterExtractionDialog` 对话框
- 实时显示角色提取任务进度
- 提取完成后自动刷新角色列表

#### 用户体验
- **空状态**: 当没有角色时，显示提取按钮和创建按钮
- **有角色时**: 在顶部显示横幅（如有任务）和操作按钮组
- **按钮紧凑设计**: 使用简短文本（"提取" 而不是 "从剧本提取"）以适应侧边栏宽度

### 2. 场景列表组件
**文件**: `src/components/projects/editor/resource-panel/scene-list.tsx`

#### 新增功能
- 添加"从剧本提取"按钮（当项目有剧集时显示）
- 集成 `SceneExtractionBanner` 横幅组件（compact 模式）
- 集成 `SceneExtractionDialog` 对话框
- 实时显示场景提取任务进度
- 提取完成后自动刷新场景列表

#### 用户体验
- **空状态**: 当没有场景时，显示提取按钮和创建按钮
- **有场景时**: 在顶部显示横幅（如有任务）和操作按钮组
- **按钮紧凑设计**: 使用简短文本（"提取" 而不是 "从剧本提取"）

### 3. 角色提取横幅组件
**文件**: `src/components/projects/characters/character-extraction-banner.tsx`

#### 新增属性
- `compact?: boolean` - 紧凑模式，用于侧边栏显示

#### Compact 模式特性
- 减小内边距（`p-3` 而不是 `p-4`）
- 减小图标尺寸（8x8 而不是 10x10）
- 简化文本（"提取中..." 而不是 "正在从剧本提取角色"）
- 隐藏详细描述文本
- 进度条不显示百分比
- 按钮使用 `sm` 尺寸
- 简化徽章显示（只显示数量，不显示 "个角色"）

### 4. 场景提取横幅组件
**文件**: `src/components/projects/scenes/scene-extraction-banner.tsx`

#### 新增属性
- `compact?: boolean` - 紧凑模式，用于侧边栏显示

#### Compact 模式特性
- 减小内边距（`p-3` 而不是 `p-4`）
- 减小图标尺寸（8x8 而不是 10x10）
- 简化文本（"提取中..." 而不是 "正在从剧本提取场景"）
- 隐藏详细描述文本
- 进度条不显示百分比
- 按钮使用 `sm` 尺寸
- 简化徽章显示（只显示数量）

## 功能流程

### 角色提取流程
1. 用户在编辑器左侧资源面板切换到"角色"标签
2. 点击"提取"按钮（渐变背景，带 Sparkles 图标）
3. 提交角色提取任务到后台
4. 横幅实时显示任务进度
5. 提取完成后，横幅显示"提取完成"和"查看"按钮
6. 点击"查看"打开预览对话框
7. 用户在对话框中选择要导入的角色
8. 确认导入后，角色列表自动刷新

### 场景提取流程
1. 用户在编辑器左侧资源面板切换到"场景"标签
2. 点击"提取"按钮（渐变背景，带 Sparkles 图标）
3. 提交场景提取任务到后台
4. 横幅实时显示任务进度
5. 提取完成后，横幅显示"提取完成"和"查看"按钮
6. 点击"查看"打开预览对话框
7. 用户在对话框中选择要导入的场景
8. 确认导入后，场景列表自动刷新

## 技术细节

### 状态管理
- 使用 `useState` 管理对话框开关状态
- 使用 `useState` 管理提取任务 ID
- 使用 `useState` 管理最近导入的任务 ID（用于横幅状态）
- 通过 `useEditor` hook 访问编辑器上下文
- 调用 `updateProject` 方法刷新项目数据

### 任务订阅
- 横幅组件通过 `useTaskSubscription` hook 实时订阅任务状态
- SSE (Server-Sent Events) 推送任务进度更新
- 自动显示/隐藏横幅基于任务状态

### 样式设计
- 使用渐变背景突出提取按钮（`from-primary/10 to-purple-500/10`）
- Compact 模式适配侧边栏狭窄空间
- 响应式图标和文本大小
- 保持与主页面功能一致的视觉风格

## 对比：编辑器 vs 管理页面

| 特性 | 编辑器模式 | 管理页面模式 |
|------|-----------|-------------|
| 入口位置 | 资源面板顶部 | 页面顶部 |
| 横幅显示 | Compact 模式 | 完整模式 |
| 按钮文本 | 简短（"提取"） | 完整（"从剧本提取"） |
| 详细说明 | 隐藏 | 显示 |
| 进度百分比 | 隐藏 | 显示 |
| 使用场景 | 快速操作 | 专注管理 |

## 测试要点

### 功能测试
1. ✅ 编辑器中角色提取按钮可点击
2. ✅ 角色提取任务正确提交
3. ✅ 角色提取横幅正确显示进度
4. ✅ 提取完成后可打开预览对话框
5. ✅ 导入角色后列表自动刷新
6. ✅ 编辑器中场景提取按钮可点击
7. ✅ 场景提取任务正确提交
8. ✅ 场景提取横幅正确显示进度
9. ✅ 提取完成后可打开预览对话框
10. ✅ 导入场景后列表自动刷新

### UI/UX 测试
1. ✅ Compact 模式横幅适配侧边栏宽度
2. ✅ 按钮组布局合理，不拥挤
3. ✅ 图标和文本大小适中
4. ✅ 渐变背景效果明显但不刺眼
5. ✅ 空状态提示清晰

### 边界情况
1. ✅ 没有剧集时不显示提取按钮
2. ✅ 多个任务运行时正确显示
3. ✅ 任务失败时正确显示错误信息
4. ✅ 关闭横幅后不再显示

## 用户价值

### 提升工作效率
- 无需离开编辑器页面即可提取角色和场景
- 减少页面切换，提升工作流畅度
- 实时反馈，及时了解提取进度

### 改善用户体验
- 功能位置更符合用户心智模型（在资源面板中管理资源）
- Compact 设计不占用过多空间
- 保持与管理页面功能的一致性

### 提高操作便捷性
- 一键提取，快速开始
- 提取完成立即可查看和导入
- 自动刷新，无需手动重载

## 后续优化建议

1. **键盘快捷键**: 为提取操作添加快捷键（如 `Ctrl+Shift+E`）
2. **批量操作**: 支持同时提取角色和场景
3. **智能推荐**: 根据剧本内容推荐最佳提取时机
4. **提取历史**: 记录提取历史，支持查看和恢复
5. **增量提取**: 只提取新增的角色和场景，避免重复

## 相关文档

- [角色提取功能文档](./character-extraction-feature.md)
- [场景提取功能文档](./scene-extraction-feature.md)
- [编辑器架构文档](./editor-architecture.md)（如果存在）

## 维护说明

### 代码位置
- 角色列表: `src/components/projects/editor/resource-panel/character-list.tsx`
- 场景列表: `src/components/projects/editor/resource-panel/scene-list.tsx`
- 角色横幅: `src/components/projects/characters/character-extraction-banner.tsx`
- 场景横幅: `src/components/projects/scenes/scene-extraction-banner.tsx`

### 依赖关系
- 依赖编辑器上下文 (`useEditor`)
- 依赖任务订阅系统 (`useTaskSubscription`)
- 依赖角色/场景提取 actions
- 依赖对话框组件

### 注意事项
- 修改横幅组件时记得同时考虑 compact 和正常模式
- 保持编辑器模式和管理页面模式的功能一致性
- 确保提取完成后正确刷新项目数据

