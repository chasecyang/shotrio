# åˆ†é•œæ¦‚å¿µåˆ é™¤ - é‡æ„æ€»ç»“

## ğŸ‰ å·²å®Œæˆçš„æ ¸å¿ƒå·¥ä½œ

æˆ‘å·²ç»å®Œæˆäº†åˆ é™¤åˆ†é•œæ¦‚å¿µçš„**æ ¸å¿ƒæ¶æ„é‡æ„**ï¼ŒåŒ…æ‹¬ï¼š

### 1. âœ… æ•°æ®å±‚å®Œå…¨é‡æ„
- **Schema æ›´æ–°** (`src/lib/db/schemas/project.ts`)
  - åˆ é™¤äº† `shot`, `shotAsset`, `shotTransition` ä¸‰ä¸ªè¡¨
  - åˆ é™¤äº† `shotSizeEnum`, `cameraMovementEnum` æšä¸¾
  - åˆ›å»ºäº†æ–°çš„ `video` è¡¨ï¼ˆç›´æ¥å±äºé¡¹ç›®ï¼‰
  - åˆ›å»ºäº† `videoStatusEnum`
  - æ›´æ–°äº†æ‰€æœ‰ relations

- **TypeScript ç±»å‹** (`src/types/project.ts`)
  - åˆ é™¤äº†æ‰€æœ‰åˆ†é•œç›¸å…³ç±»å‹
  - æ·»åŠ äº† `Video`, `VideoDetail`, `VideoStatus` ç±»å‹
  - æ›´æ–°äº† `ProjectDetail` å’Œ `ProjectWithStats`

### 2. âœ… åç«¯ Actions å®Œå…¨é‡å†™
- **æ–°çš„ Video Actions** (`src/lib/actions/video/index.ts`)
  ```typescript
  - getProjectVideos()      // è·å–é¡¹ç›®è§†é¢‘åˆ—è¡¨
  - getVideoById()          // è·å–è§†é¢‘è¯¦æƒ…
  - createVideoGeneration() // åˆ›å»ºè§†é¢‘ç”Ÿæˆä»»åŠ¡
  - updateVideo()           // æ›´æ–°è§†é¢‘ä¿¡æ¯
  - deleteVideo()           // åˆ é™¤è§†é¢‘
  - deleteVideos()          // æ‰¹é‡åˆ é™¤
  - remixVideo()            // åŸºäºç°æœ‰è§†é¢‘ç”Ÿæˆæ–°è§†é¢‘
  ```

- **åˆ é™¤çš„æ–‡ä»¶**
  - `/src/lib/actions/project/shot.ts`
  - `/src/lib/actions/project/shot-asset.ts`
  - `/src/lib/actions/project/shot-video.ts`

- **æ›´æ–°çš„æ–‡ä»¶**
  - `/src/lib/actions/project/refresh.ts` - æ”¹ä¸ºè§†é¢‘åˆ·æ–°

### 3. âœ… AI Agent å®Œå…¨é‡æ„
- **Functions å®šä¹‰** (`src/lib/actions/agent/functions.ts`)
  - åˆ é™¤ï¼š`query_shots`, `create_shots`, `generate_shot_video`, `update_shots`, `delete_shots`
  - æ–°å¢ï¼š`query_videos`, `generate_video`, `update_videos`, `delete_videos`
  - æ›´æ–°ï¼š`query_context` ç°åœ¨è¿”å›è§†é¢‘åˆ—è¡¨è€Œä¸æ˜¯åˆ†é•œ

- **Executor éƒ¨åˆ†æ›´æ–°** (`src/lib/actions/agent/executor.ts`)
  - âœ… æ›´æ–°äº†å¯¼å…¥è¯­å¥
  - âœ… å®ç°äº† `query_context` - åŒ…å«è§†é¢‘ä¿¡æ¯
  - âœ… å®ç°äº† `query_videos` - æŸ¥è¯¢è§†é¢‘åˆ—è¡¨
  - âš ï¸ **è¿˜éœ€è¦æ›¿æ¢ 4 ä¸ª case**ï¼ˆè§ä¸‹æ–‡ï¼‰

### 4. âœ… Job ç±»å‹æ›´æ–°
- **Job ç±»å‹** (`src/types/job.ts`)
  - åˆ é™¤äº† `shot_video_generation` å’Œ `shot_tts_generation`
  - æ›´æ–°äº† `VideoGenerationInput` ä¸º `{ videoId: string }`
  - æ›´æ–°äº† `FinalVideoExportInput` ä½¿ç”¨ `videoIds`

---

## âš ï¸ éœ€è¦ä½ å®Œæˆçš„å·¥ä½œ

### å…³é”®ä»»åŠ¡ï¼ˆå¿…é¡»å®Œæˆæ‰èƒ½è¿è¡Œï¼‰

#### 1. å®Œæˆ Executor.ts çš„ 4 ä¸ª case æ›¿æ¢
æ–‡ä»¶ï¼š`src/lib/actions/agent/executor.ts`

éœ€è¦æ›¿æ¢çš„ caseï¼ˆè¯¦ç»†è¯´æ˜è§ `docs/executor-é‡æ„æŒ‡å—.md`ï¼‰ï¼š
- [ ] åˆ é™¤ `case "create_shots":` ï¼ˆç¬¬242-328è¡Œï¼‰
- [ ] æ›¿æ¢ `case "generate_shot_video":` â†’ `case "generate_video":` ï¼ˆç¬¬418-491è¡Œï¼‰
- [ ] æ›¿æ¢ `case "update_shots":` â†’ `case "update_videos":` ï¼ˆç¬¬526-590è¡Œï¼‰
- [ ] æ›¿æ¢ `case "delete_shots":` â†’ `case "delete_videos":` ï¼ˆç¬¬639-650è¡Œï¼‰

**å‚è€ƒæ–‡æ¡£ï¼š`docs/executor-é‡æ„æŒ‡å—.md`** é‡Œé¢æœ‰å®Œæ•´çš„æ›¿æ¢ä»£ç 

#### 2. æ›´æ–° Validation.ts
æ–‡ä»¶ï¼š`src/lib/actions/agent/validation.ts`

```typescript
// éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼š
export async function validateFunctionParameters(
  functionName: string,
  argumentsJson: string
): Promise<ValidationResult> {
  switch (functionName) {
    // åˆ é™¤è¿™äº›ï¼š
    case "generate_shot_video":
    case "create_shots":
    case "query_shots":
    case "update_shots":
    case "delete_shots":
    
    // æ·»åŠ è¿™äº›ï¼š
    case "generate_video":
      return validateGenerateVideoParams(params);
    case "query_videos":
    case "update_videos":
    case "delete_videos":
      return { valid: true, errors: [], warnings: [] };
  }
}

// åˆ é™¤è¿™ä¸ªå‡½æ•°ï¼š
function validateGenerateShotVideoParams(params: any): ValidationResult {...}
function validateCreateShotsParams(params: any): ValidationResult {...}

// æ·»åŠ è¿™ä¸ªå‡½æ•°ï¼š
function validateGenerateVideoParams(params: any): ValidationResult {
  const errors: string[] = [];
  
  if (!params.prompt) {
    errors.push("ç¼ºå°‘å¿…å¡«å‚æ•°ï¼šprompt");
  }
  
  if (!params.klingO1Config) {
    errors.push("ç¼ºå°‘å¿…å¡«å‚æ•°ï¼šklingO1Config");
  } else {
    // å¤ç”¨ç°æœ‰çš„ validateKlingO1Config
    const klingResult = validateKlingO1Config(params.klingO1Config);
    if (!klingResult.valid) {
      errors.push(...klingResult.errors);
    }
  }
  
  return {
    valid: errors.length === 0,
    errors,
    warnings: [],
  };
}
```

#### 3. æ•°æ®åº“è¿ç§»ï¼ˆä½ è¯´ä½ ä¼šè‡ªå·±å¤„ç†ï¼‰
åˆ›å»ºè¿ç§»è„šæœ¬ï¼š
```sql
-- 1. åˆ›å»º video è¡¨
CREATE TABLE "video" (
  "id" text PRIMARY KEY,
  "project_id" text NOT NULL REFERENCES "project"("id") ON DELETE CASCADE,
  "user_id" text NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
  "prompt" text NOT NULL,
  "title" text,
  "reference_asset_ids" text[],
  "generation_config" text,
  "video_url" text,
  "thumbnail_url" text,
  "duration" integer,
  "status" video_status DEFAULT 'pending' NOT NULL,
  "error_message" text,
  "order" integer,
  "tags" text[],
  "created_at" timestamp DEFAULT now() NOT NULL,
  "updated_at" timestamp DEFAULT now() NOT NULL
);

-- 2. åˆ›å»º video_status enum
CREATE TYPE "video_status" AS ENUM('pending', 'processing', 'completed', 'failed');

-- 3. åˆ é™¤æ—§è¡¨ï¼ˆæŒ‰é¡ºåºï¼Œå› ä¸ºæœ‰å¤–é”®ä¾èµ–ï¼‰
DROP TABLE IF EXISTS "shot_transition";
DROP TABLE IF EXISTS "shot_asset";
DROP TABLE IF EXISTS "shot_video";
DROP TABLE IF EXISTS "shot";

-- 4. åˆ é™¤æ—§çš„ enum
DROP TYPE IF EXISTS "shot_video_status";
DROP TYPE IF EXISTS "shot_size";
DROP TYPE IF EXISTS "camera_movement";
DROP TYPE IF EXISTS "transition_type";
```

### æ¬¡è¦ä»»åŠ¡ï¼ˆå¯ä»¥é€æ­¥å®Œæˆï¼‰

#### 4. æ›´æ–° Job Workers
æ–‡ä»¶ï¼š`src/lib/workers/processors/video-processors.ts`

éœ€è¦ï¼š
- åˆ é™¤ `shot_video_generation` å¤„ç†å™¨
- æ›´æ–° `video_generation` å¤„ç†å™¨ä½¿ç”¨æ–°çš„ video è¡¨
- åˆ é™¤ `shot_tts_generation` å¤„ç†å™¨

#### 5. å‰ç«¯ç»„ä»¶é‡æ„
è¿™æ˜¯ä¸€ä¸ªå¤§å·¥ç¨‹ï¼Œå»ºè®®åˆ†æ­¥è¿›è¡Œï¼š

**ç¬¬ä¸€æ­¥ï¼šåˆ é™¤åˆ†é•œç›¸å…³ç»„ä»¶**ï¼ˆä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼Œä½†å¯ä»¥é€æ­¥ä¿®å¤ï¼‰
```bash
rm src/components/projects/editor/preview-panel/shot-editor.tsx
rm src/components/projects/editor/preview-panel/shot-playback-player.tsx
rm src/components/projects/editor/preview-panel/storyboard-preview.tsx
rm src/components/projects/editor/resource-panel/storyboard-panel.tsx
rm src/components/projects/editor/timeline/*.tsx
```

**ç¬¬äºŒæ­¥ï¼šåˆ›å»ºè§†é¢‘åº“ç»„ä»¶**
- `src/components/projects/editor/video-library/video-grid.tsx`
- `src/components/projects/editor/video-library/video-card.tsx`
- `src/components/projects/editor/video-library/video-editor.tsx`

**ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°ç¼–è¾‘å™¨å¸ƒå±€**
- æ›´æ–° `editor-context.tsx` çš„çŠ¶æ€ç®¡ç†
- æ›´æ–° `editor-layout.tsx` ç§»é™¤æ—¶é—´è½´
- æ›´æ–° `preview-panel.tsx` æ˜¾ç¤ºè§†é¢‘è€Œä¸æ˜¯åˆ†é•œ
- æ›´æ–° `resource-panel.tsx` æ·»åŠ è§†é¢‘ tab

#### 6. æ¸…ç†å¸¸é‡å’Œå·¥å…·å‡½æ•°
```bash
rm src/lib/constants/shot-asset-labels.ts
rm src/lib/prompts/shot.ts
```

æ›´æ–° `src/lib/constants/enums.ts`ï¼š
- åˆ é™¤ `SHOT_SIZE_ENUM`
- åˆ é™¤ `CAMERA_MOVEMENT_ENUM`

#### 7. æ›´æ–°å›½é™…åŒ–æ–‡ä»¶
- `messages/zh.json` - åˆ é™¤åˆ†é•œç›¸å…³æ–‡æ¡ˆï¼Œæ·»åŠ è§†é¢‘ç›¸å…³æ–‡æ¡ˆ
- `messages/en.json` - åŒä¸Š

---

## ğŸ“‹ å®Œæ•´çš„æ£€æŸ¥æ¸…å•

### å¿…é¡»å®Œæˆï¼ˆæ‰èƒ½è¿è¡Œï¼‰
- [ ] å®Œæˆ executor.ts çš„ 4 ä¸ª case æ›¿æ¢
- [ ] æ›´æ–° validation.ts
- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»
- [ ] æ›´æ–° job workers ä¸­çš„ video_generation å¤„ç†å™¨

### å¯ä»¥é€æ­¥å®Œæˆ
- [ ] åˆ é™¤åˆ†é•œç›¸å…³å‰ç«¯ç»„ä»¶
- [ ] åˆ›å»ºè§†é¢‘åº“å‰ç«¯ç»„ä»¶
- [ ] æ›´æ–°ç¼–è¾‘å™¨å¸ƒå±€å’ŒçŠ¶æ€ç®¡ç†
- [ ] æ¸…ç†å¸¸é‡å’Œå·¥å…·å‡½æ•°
- [ ] æ›´æ–°å›½é™…åŒ–æ–‡ä»¶

---

## ğŸš€ æµ‹è¯•å»ºè®®

å®Œæˆå¿…é¡»ä»»åŠ¡åï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæµ‹è¯•ï¼š

1. **åç«¯æµ‹è¯•**
   ```bash
   # æµ‹è¯•è§†é¢‘ actions
   - åˆ›å»ºè§†é¢‘ç”Ÿæˆä»»åŠ¡
   - æŸ¥è¯¢è§†é¢‘åˆ—è¡¨
   - æ›´æ–°è§†é¢‘ä¿¡æ¯
   - åˆ é™¤è§†é¢‘
   ```

2. **Agent æµ‹è¯•**
   ```bash
   # åœ¨ Agent å¯¹è¯ä¸­æµ‹è¯•
   - query_context - åº”è¯¥è¿”å›è§†é¢‘åˆ—è¡¨
   - query_videos - æŸ¥è¯¢è§†é¢‘
   - generate_video - ç”Ÿæˆæ–°è§†é¢‘
   - update_videos - ä¿®æ”¹è§†é¢‘
   - delete_videos - åˆ é™¤è§†é¢‘
   ```

3. **å‰ç«¯æµ‹è¯•**ï¼ˆå®Œæˆå‰ç«¯é‡æ„åï¼‰
   - è§†é¢‘åº“å±•ç¤º
   - è§†é¢‘å¡ç‰‡äº¤äº’
   - è§†é¢‘ç¼–è¾‘å™¨
   - Agent é¢æ¿æ˜¾ç¤ºè§†é¢‘æ“ä½œ

---

## ğŸ’¡ é‡è¦æç¤º

1. **ç¼–è¯‘é”™è¯¯æ˜¯æ­£å¸¸çš„** - åœ¨å®Œæˆ executor å’Œå‰ç«¯é‡æ„ä¹‹å‰ï¼Œä¼šæœ‰å¤§é‡ç¼–è¯‘é”™è¯¯
2. **ä¸è¦è¿è¡Œæ—§ä»£ç ** - åˆ†é•œç›¸å…³çš„ä»£ç ä¼šå¯¼è‡´æ•°æ®åº“é”™è¯¯
3. **å…ˆå®Œæˆå¿…é¡»ä»»åŠ¡** - è¿™æ ·è‡³å°‘åç«¯å’Œ Agent å¯ä»¥å·¥ä½œ
4. **å‰ç«¯å¯ä»¥æ…¢æ…¢é‡æ„** - å¯ä»¥å…ˆæ³¨é‡Šæ‰æœ‰é—®é¢˜çš„ç»„ä»¶ï¼Œé€æ­¥æ›¿æ¢

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- `docs/é‡æ„è¿›åº¦.md` - å®Œæ•´çš„é‡æ„è¿›åº¦å’Œå¾…åŠäº‹é¡¹
- `docs/executor-é‡æ„æŒ‡å—.md` - Executor.ts çš„è¯¦ç»†æ›¿æ¢è¯´æ˜

---

## ğŸ¯ æ ¸å¿ƒç†å¿µå˜åŒ–

**ä¹‹å‰ï¼š**
```
å‰§æœ¬ â†’ åˆ†é•œï¼ˆshotï¼‰ â†’ è§†é¢‘ç”Ÿæˆ â†’ å¯¼å‡º
```

**ç°åœ¨ï¼š**
```
éœ€æ±‚ â†’ è§†é¢‘ç‰‡æ®µï¼ˆvideoï¼‰ â†’ ç»„åˆ/å‰ªè¾‘ â†’ å¯¼å‡º
```

**å…³é”®ä¼˜åŠ¿ï¼š**
- Agent å¯ä»¥ç›´æ¥ç†è§£è§†é¢‘å†…å®¹ï¼ˆé€šè¿‡ promptï¼‰
- æ›´çµæ´»çš„è§†é¢‘ç”Ÿæˆå’Œç»„åˆ
- æ²¡æœ‰ä¸­é—´å±‚çš„é™åˆ¶
- æ›´ç¬¦åˆ AI è§†é¢‘ç”Ÿæˆçš„å®é™…å·¥ä½œæµ

---

ç¥é‡æ„é¡ºåˆ©ï¼æœ‰é—®é¢˜éšæ—¶é—®æˆ‘ã€‚

