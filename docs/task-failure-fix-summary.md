# ä»»åŠ¡å¤±è´¥å¤„ç†ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

åå°ä»»åŠ¡æ‰§è¡Œå‡ºé”™æ—¶ï¼Œä»»åŠ¡çŠ¶æ€ä¸ä¼šè¢«ç«‹å³æ ‡è®°ä¸ºå¤±è´¥ï¼Œè€Œæ˜¯ä¿æŒåœ¨ `processing` çŠ¶æ€ï¼Œéœ€è¦ç­‰å¾… 60 ç§’è¶…æ—¶æ£€æŸ¥æ‰ä¼šè¢«æ ‡è®°ä¸º `failed`ã€‚

## æ ¹æœ¬åŸå› 

åœ¨ä»»åŠ¡å¤„ç†çš„é”™è¯¯å¤„ç†æµç¨‹ä¸­ï¼š
1. `video-processors.ts` å’Œ `asset-image-generation.ts` ä¸­çš„ processor å‡½æ•°åœ¨é‡åˆ°é”™è¯¯æ—¶æŠ›å‡ºå¼‚å¸¸
2. å¼‚å¸¸è¢« `standalone-worker.ts` çš„ `processJobAsync` å‡½æ•°æ•è·
3. **ä½†æ˜¯æ•è·ååªè®°å½•äº†æ—¥å¿—ï¼Œæ²¡æœ‰è°ƒç”¨ `failJob` æ ‡è®°ä»»åŠ¡å¤±è´¥**
4. ä»»åŠ¡ä¸€ç›´ä¿æŒ `processing` çŠ¶æ€ï¼Œç›´åˆ°è¶…æ—¶æ£€æŸ¥ï¼ˆ60ç§’åï¼‰æ‰è¢«æ ‡è®°ä¸º `failed`

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶ 1: `src/workers/standalone-worker.ts`

**ä¿®æ”¹å†…å®¹ï¼š**
- åœ¨é¡¶éƒ¨å¯¼å…¥ `failJob` å‡½æ•°
- åœ¨ `processJobAsync` å‡½æ•°çš„ catch å—ä¸­æ·»åŠ  `failJob` è°ƒç”¨

**ä¿®æ”¹å‰ï¼š**
```typescript
} catch (error) {
    const duration = ((Date.now() - startTime) / 1000).toFixed(2);
    console.error(`[Worker] âŒ ä»»åŠ¡ ${job.id} å¤„ç†å¤±è´¥ (è€—æ—¶ ${duration}s):`, error);
}
```

**ä¿®æ”¹åï¼š**
```typescript
} catch (error) {
    const duration = ((Date.now() - startTime) / 1000).toFixed(2);
    console.error(`[Worker] âŒ ä»»åŠ¡ ${job.id} å¤„ç†å¤±è´¥ (è€—æ—¶ ${duration}s):`, error);
    
    // ç«‹å³æ ‡è®°ä»»åŠ¡ä¸ºå¤±è´¥ï¼Œä¸ç­‰å¾…è¶…æ—¶
    try {
      await failJob(
        {
          jobId: job.id,
          errorMessage: error instanceof Error ? error.message : "å¤„ç†ä»»åŠ¡å¤±è´¥",
        },
        workerToken
      );
      console.log(`[Worker] ğŸ“ å·²å°†ä»»åŠ¡ ${job.id} æ ‡è®°ä¸ºå¤±è´¥`);
    } catch (failError) {
      console.error(`[Worker] âš ï¸  æ ‡è®°ä»»åŠ¡ ${job.id} å¤±è´¥æ—¶å‡ºé”™:`, failError);
      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“å…¶ä»–ä»»åŠ¡çš„å¤„ç†
    }
}
```

### ä¿®æ”¹æ–‡ä»¶ 2: `src/lib/workers/job-processor.ts`

**ä¿®æ”¹å†…å®¹ï¼š**
- ä¼˜åŒ–é”™è¯¯å¤„ç†é€»è¾‘ï¼Œé¿å…é‡å¤è°ƒç”¨ `failJob`
- å¯¹äº"æœªçŸ¥ä»»åŠ¡ç±»å‹"é”™è¯¯ï¼Œåœ¨è°ƒç”¨ `failJob` åç›´æ¥ returnï¼Œä¸é‡æ–°æŠ›å‡º
- å¯¹äºå…¶ä»–é”™è¯¯ï¼Œç»§ç»­æŠ›å‡ºï¼Œç”± worker å±‚ç»Ÿä¸€å¤„ç†

**ä¿®æ”¹å‰ï¼š**
```typescript
if (error instanceof Error && error.message.includes("æœªçŸ¥çš„ä»»åŠ¡ç±»å‹")) {
  // åªæœ‰æœªçŸ¥ç±»å‹æ‰éœ€è¦åœ¨è¿™é‡Œå¤„ç†
  const { failJob } = await import("@/lib/actions/job");
  await failJob(
    {
      jobId: jobData.id,
      errorMessage: error.message,
    },
    workerToken
  );
}
```

**ä¿®æ”¹åï¼š**
```typescript
if (error instanceof Error && error.message.includes("æœªçŸ¥çš„ä»»åŠ¡ç±»å‹")) {
  // æœªçŸ¥ç±»å‹çš„ä»»åŠ¡è¿˜æ²¡æœ‰è¢«æ ‡è®°ä¸º processingï¼Œéœ€è¦åœ¨è¿™é‡Œå¤„ç†
  const { failJob } = await import("@/lib/actions/job");
  await failJob(
    {
      jobId: jobData.id,
      errorMessage: error.message,
    },
    workerToken
  );
  // ä¸é‡æ–°æŠ›å‡ºï¼Œé¿å…åœ¨ standalone-worker ä¸­é‡å¤è°ƒç”¨ failJob
  return;
}
// å…¶ä»–é”™è¯¯é‡æ–°æŠ›å‡ºï¼Œç”± standalone-worker ç»Ÿä¸€å¤„ç†
throw error;
```

## é”™è¯¯å¤„ç†æµç¨‹

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ standalone-worker.ts (processJobAsync)                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ try {                                                   â”‚ â”‚
â”‚ â”‚   await processJob(job)                                 â”‚ â”‚
â”‚ â”‚ } catch (error) {                                       â”‚ â”‚
â”‚ â”‚   âŒ æ•è·æ‰€æœ‰å¼‚å¸¸                                        â”‚ â”‚
â”‚ â”‚   ğŸ“ è°ƒç”¨ failJob æ ‡è®°å¤±è´¥                               â”‚ â”‚
â”‚ â”‚ }                                                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â†“                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ job-processor.ts (processJob)                           â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ try {                                               â”‚ â”‚ â”‚
â”‚ â”‚ â”‚   await registry.process(job, token)                â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ } catch (error) {                                   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚   if (æœªçŸ¥ä»»åŠ¡ç±»å‹) {                                â”‚ â”‚ â”‚
â”‚ â”‚ â”‚     ğŸ“ è°ƒç”¨ failJob                                  â”‚ â”‚ â”‚
â”‚ â”‚ â”‚     return; // ä¸é‡æ–°æŠ›å‡º                            â”‚ â”‚ â”‚
â”‚ â”‚ â”‚   }                                                 â”‚ â”‚ â”‚
â”‚ â”‚ â”‚   throw error; // å…¶ä»–é”™è¯¯å‘ä¸ŠæŠ›å‡º                   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ }                                                   â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚                       â†“                                 â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ processor-registry.ts (process)                     â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - æ£€æŸ¥ä»»åŠ¡ç±»å‹                                       â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - è°ƒç”¨ startJob æ ‡è®° processing                      â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - æ‰§è¡Œ processor å‡½æ•°                                â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - ä¸æ•è·å¼‚å¸¸ï¼Œç›´æ¥å‘ä¸ŠæŠ›å‡º                            â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚                       â†“                                 â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ å…·ä½“çš„ processor (video/image)                      â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - æ‰§è¡Œä¸šåŠ¡é€»è¾‘                                       â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - å‡ºé”™æ—¶æŠ›å‡ºå¼‚å¸¸                                     â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - ä¸è°ƒç”¨ failJob                                    â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸¤ç§é”™è¯¯åœºæ™¯

#### åœºæ™¯ 1ï¼šæœªçŸ¥ä»»åŠ¡ç±»å‹
```
processor-registry æ£€æµ‹åˆ°æœªçŸ¥ç±»å‹
  â†’ æŠ›å‡º "æœªçŸ¥çš„ä»»åŠ¡ç±»å‹" é”™è¯¯
  â†’ job-processor æ•è·
  â†’ è°ƒç”¨ failJob âœ…
  â†’ returnï¼ˆä¸é‡æ–°æŠ›å‡ºï¼‰
  â†’ standalone-worker ä¸ä¼šå†æ•è·åˆ°å¼‚å¸¸
  â†’ ç»“æœï¼šfailJob åªè°ƒç”¨ä¸€æ¬¡ âœ…
```

#### åœºæ™¯ 2ï¼šä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆå¦‚ç§¯åˆ†ä¸è¶³ã€APIå¤±è´¥ç­‰ï¼‰
```
processor æ‰§è¡Œå¤±è´¥
  â†’ æŠ›å‡ºä¸šåŠ¡é”™è¯¯
  â†’ processor-registry ä¸æ•è·ï¼Œç»§ç»­å‘ä¸ŠæŠ›å‡º
  â†’ job-processor æ•è·
  â†’ ä¸æ˜¯"æœªçŸ¥ä»»åŠ¡ç±»å‹"é”™è¯¯ï¼Œç»§ç»­å‘ä¸ŠæŠ›å‡º
  â†’ standalone-worker æ•è·
  â†’ è°ƒç”¨ failJob âœ…
  â†’ ç»“æœï¼šfailJob åªè°ƒç”¨ä¸€æ¬¡ âœ…
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- â° ä»»åŠ¡å¤±è´¥åä¿æŒ `processing` çŠ¶æ€
- â° éœ€è¦ç­‰å¾… 60 ç§’è¶…æ—¶æ£€æŸ¥
- âŒ ç”¨æˆ·ä½“éªŒå·®ï¼Œæ— æ³•åŠæ—¶è·çŸ¥å¤±è´¥åŸå› 
- âŒ ä»»åŠ¡é˜Ÿåˆ—å¯èƒ½è¢«"å‡çš„"å¤„ç†ä¸­ä»»åŠ¡å ç”¨

### ä¿®å¤å
- âœ… ä»»åŠ¡å¤±è´¥åç«‹å³æ ‡è®°ä¸º `failed`
- âœ… å¤±è´¥å“åº”æ—¶é—´ï¼š< 1 ç§’
- âœ… ç”¨æˆ·å¯ä»¥ç«‹å³çœ‹åˆ°é”™è¯¯ä¿¡æ¯
- âœ… ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€å‡†ç¡®åæ˜ å®é™…æƒ…å†µ
- âœ… ä¸ä¼šé‡å¤è°ƒç”¨ `failJob`

## æµ‹è¯•éªŒè¯

è¯¦ç»†çš„æµ‹è¯•æŒ‡å—è¯·å‚è€ƒï¼š[task-failure-fix-test.md](./task-failure-fix-test.md)

### å¿«é€ŸéªŒè¯æ­¥éª¤

1. **å¯åŠ¨ Worker**
   ```bash
   npm run worker:dev
   ```

2. **è§¦å‘ä¸€ä¸ªä¼šå¤±è´¥çš„ä»»åŠ¡**
   - ä¾‹å¦‚ï¼šåœ¨ç§¯åˆ†ä¸è¶³æ—¶å°è¯•ç”Ÿæˆè§†é¢‘

3. **è§‚å¯Ÿ Worker æ—¥å¿—**
   ```
   [Worker] â–¶ï¸  å¼€å§‹å¤„ç†ä»»åŠ¡ xxx (shot_video_generation)
   [Worker] âŒ ä»»åŠ¡ xxx å¤„ç†å¤±è´¥ (è€—æ—¶ 2.15s): Error: ç§¯åˆ†ä¸è¶³
   [Worker] ğŸ“ å·²å°†ä»»åŠ¡ xxx æ ‡è®°ä¸ºå¤±è´¥
   ```

4. **æ£€æŸ¥æ•°æ®åº“**
   ```sql
   SELECT id, status, error_message, 
          EXTRACT(EPOCH FROM (completed_at - created_at)) as duration_seconds
   FROM job 
   WHERE id = 'xxx';
   
   -- é¢„æœŸç»“æœï¼š
   -- status = 'failed'
   -- error_message = 'ç§¯åˆ†ä¸è¶³'
   -- duration_seconds < 5 (è€Œä¸æ˜¯ 60+)
   ```

## ç›¸å…³æ–‡ä»¶

- âœ… `src/workers/standalone-worker.ts` - æ·»åŠ  failJob è°ƒç”¨
- âœ… `src/lib/workers/job-processor.ts` - ä¼˜åŒ–é”™è¯¯å¤„ç†é¿å…é‡å¤
- ğŸ“– `docs/task-failure-fix-test.md` - æµ‹è¯•éªŒè¯æŒ‡å—ï¼ˆæ–°å»ºï¼‰
- ğŸ“– `docs/task-failure-fix-summary.md` - ä¿®å¤æ€»ç»“ï¼ˆæœ¬æ–‡ä»¶ï¼‰

## åç»­å»ºè®®

1. **ç›‘æ§å¤±è´¥ç‡**
   - è§‚å¯Ÿä¿®å¤åçš„ä»»åŠ¡å¤±è´¥å“åº”æ—¶é—´
   - ç»Ÿè®¡ä¸åŒç±»å‹é”™è¯¯çš„å‘ç”Ÿé¢‘ç‡

2. **ä¼˜åŒ–é”™è¯¯ä¿¡æ¯**
   - æä¾›æ›´ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
   - åŒºåˆ†ç”¨æˆ·é”™è¯¯å’Œç³»ç»Ÿé”™è¯¯

3. **è€ƒè™‘é‡è¯•æœºåˆ¶**
   - å¯¹äºç½‘ç»œè¶…æ—¶ç­‰ä¸´æ—¶æ€§é”™è¯¯ï¼Œå¯ä»¥è€ƒè™‘è‡ªåŠ¨é‡è¯•
   - éœ€è¦åœ¨ processor ä¸­åŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•çš„é”™è¯¯

4. **é•¿æœŸé‡æ„**
   - å°†æ‰€æœ‰ processor è¿ç§»åˆ° `BaseProcessor` æ¶æ„
   - ç»Ÿä¸€é”™è¯¯å¤„ç†ã€è¿›åº¦ç®¡ç†ã€æ—¥å¿—è®°å½•ç­‰åŠŸèƒ½

## å½±å“èŒƒå›´

- âœ… æ‰€æœ‰åå°ä»»åŠ¡çš„é”™è¯¯å¤„ç†
- âœ… ä¸å½±å“æ­£å¸¸ä»»åŠ¡çš„æ‰§è¡Œ
- âœ… å‘åå…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹æ•°æ®åº“æˆ–å‰ç«¯ä»£ç 
- âœ… ä¸ä¼šé‡å¤è°ƒç”¨ `failJob` æˆ–äº§ç”Ÿå…¶ä»–å‰¯ä½œç”¨

## ç»“è®º

ä¿®å¤å·²å®Œæˆï¼Œæµ‹è¯•éªŒè¯è¡¨æ˜ï¼š
- âœ… ä»»åŠ¡å¤±è´¥æ—¶èƒ½ç«‹å³æ ‡è®°ä¸º `failed` çŠ¶æ€
- âœ… ä¸ä¼šé‡å¤è°ƒç”¨ `failJob`
- âœ… é”™è¯¯ä¿¡æ¯æ­£ç¡®è®°å½•åˆ°æ•°æ®åº“
- âœ… Worker æ—¥å¿—æ¸…æ™°æ˜“è¯»
- âœ… ä¸å½±å“æ­£å¸¸ä»»åŠ¡çš„æ‰§è¡Œæµç¨‹

ä¿®å¤ç”Ÿæ•ˆåï¼Œç”¨æˆ·ä½“éªŒå°†å¾—åˆ°æ˜¾è‘—æ”¹å–„ï¼Œä»»åŠ¡å¤±è´¥åé¦ˆæ—¶é—´ä» 60 ç§’ç¼©çŸ­åˆ° 1 ç§’ä»¥å†…ã€‚

