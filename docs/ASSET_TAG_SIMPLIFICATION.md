# ç´ ææ ‡ç­¾ç³»ç»Ÿç®€åŒ– - å®æ–½æ€»ç»“

## ğŸ“‹ æ”¹åŠ¨æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å°†ç´ ææ ‡ç­¾ç³»ç»Ÿä» `tagType + tagValue` åŒå­—æ®µç»“æ„ç®€åŒ–ä¸ºå•ä¸€ `tagValue` å­—æ®µï¼Œå¹¶æ·»åŠ äº†é¢„è®¾æ ‡ç­¾åŠŸèƒ½ã€‚

## ğŸ¯ ä¸»è¦æ”¹è¿›

### 1. æ•°æ®ç»“æ„ç®€åŒ–
- **ä¹‹å‰**: `{ tagType: "character", tagValue: "ä¸»è§’" }`
- **ç°åœ¨**: `{ tagValue: "ä¸»è§’" }`

### 2. é¢„è®¾æ ‡ç­¾
ç³»ç»Ÿæä¾›3ä¸ªé¢„è®¾å¿«æ·æ ‡ç­¾ï¼š
- ğŸ­ **è§’è‰²**
- ğŸï¸ **åœºæ™¯**
- ğŸ”¨ **é“å…·**

ç”¨æˆ·å¯ä»¥ï¼š
- ä»é¢„è®¾æ ‡ç­¾ä¸­å¿«é€Ÿé€‰æ‹©
- å®Œå…¨è‡ªç”±åœ°æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
- åŒæ—¶ä½¿ç”¨å¤šä¸ªæ ‡ç­¾ï¼ˆé¢„è®¾+è‡ªå®šä¹‰æ··åˆï¼‰

### 3. ç”¨æˆ·ä½“éªŒæå‡
- **æ ‡ç­¾è¾“å…¥**: æ”¹ç”¨ Combobox ç»„ä»¶ï¼Œæ”¯æŒæœç´¢å’Œè‡ªåŠ¨å»ºè®®
- **æ ‡ç­¾ç­›é€‰**: é¢„è®¾æ ‡ç­¾å’Œè‡ªå®šä¹‰æ ‡ç­¾åˆ†ç»„æ˜¾ç¤ºï¼Œæ›´åŠ æ¸…æ™°
- **æ ‡ç­¾å±•ç¤º**: é¢„è®¾æ ‡ç­¾ä½¿ç”¨ä¸»é¢˜è‰²å¾½ç« ï¼Œè‡ªå®šä¹‰æ ‡ç­¾ä½¿ç”¨æ¬¡è¦è‰²

## ğŸ“‚ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ•°æ®åº“å±‚
1. **`src/lib/db/schemas/project.ts`**
   - ç§»é™¤ `assetTag` è¡¨çš„ `tagType` å­—æ®µ
   - åªä¿ç•™ `tagValue` å­—æ®µ

### ç±»å‹å®šä¹‰
2. **`src/types/asset.ts`**
   - ç§»é™¤ `TagType` æšä¸¾
   - ç®€åŒ– `AssetTag` æ¥å£
   - ç®€åŒ– `CreateAssetTagInput` æ¥å£
   - ç®€åŒ– `AssetQueryFilter` æ¥å£
   - ç§»é™¤ `getAssetType()` è¾…åŠ©å‡½æ•°
   - ä¿®æ”¹ `getAssetTagValues()` ç­¾å

3. **`src/lib/constants/asset-tags.ts`** (æ–°å»º)
   - å®šä¹‰ `PRESET_TAGS` å¸¸é‡
   - å®šä¹‰ `isPresetTag()` è¾…åŠ©å‡½æ•°
   - å®šä¹‰èµ„äº§ç±»å‹åˆ°æ ‡ç­¾çš„æ˜ å°„

### ä¸šåŠ¡é€»è¾‘å±‚
4. **`src/lib/actions/asset/tags.ts`**
   - ç§»é™¤æ‰€æœ‰ `tagType` å‚æ•°
   - ç®€åŒ–ä¸ºåªä½¿ç”¨ `tagValue`

5. **`src/lib/actions/asset/queries.ts`**
   - ç®€åŒ–æ ‡ç­¾ç­›é€‰é€»è¾‘
   - æ›´æ–° `getAssetsByTag()` å‡½æ•°

6. **`src/lib/actions/asset/crud.ts`**
   - æ›´æ–°åˆ›å»ºèµ„äº§æ—¶çš„æ ‡ç­¾æ’å…¥é€»è¾‘

7. **`src/lib/actions/asset/generate-asset.ts`**
   - ä½¿ç”¨é¢„è®¾æ ‡ç­¾æ˜ å°„è‡ªåŠ¨æ·»åŠ æ ‡ç­¾

8. **`src/lib/actions/asset/derivation.ts`**
   - ç®€åŒ–æ ‡ç­¾å¤åˆ¶é€»è¾‘

9. **`src/lib/actions/asset/upload-asset.ts`**
   - ä½¿ç”¨é¢„è®¾æ ‡ç­¾æ˜ å°„

### UIç»„ä»¶
10. **`src/components/projects/editor/resource-panel/asset-detail-dialog.tsx`**
    - å°†æ ‡ç­¾è¾“å…¥æ”¹ä¸º Combobox
    - æ˜¾ç¤ºé¢„è®¾æ ‡ç­¾å»ºè®®
    - æ”¯æŒåˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾
    - é¢„è®¾æ ‡ç­¾ä½¿ç”¨ä¸»é¢˜è‰²å¾½ç« 

11. **`src/components/projects/editor/resource-panel/tag-filter.tsx`**
    - ç§»é™¤æŒ‰ tagType åˆ†ç»„çš„é€»è¾‘
    - æ”¹ä¸ºé¢„è®¾/è‡ªå®šä¹‰åˆ†ç»„
    - é¢„è®¾æ ‡ç­¾æŒ‰é¡ºåºæ’åˆ—

12. **`src/components/projects/editor/resource-panel/asset-panel.tsx`**
    - æ›´æ–°æ¥å£ä»¥ä½¿ç”¨ç®€åŒ–çš„æ ‡ç­¾ç»“æ„

13. **`src/components/projects/editor/resource-panel/asset-card.tsx`**
    - ç§»é™¤ `getAssetType()` è°ƒç”¨
    - ç›´æ¥ä»æ ‡ç­¾ä¸­æŸ¥æ‰¾é¢„è®¾ç±»å‹

14. **`src/components/projects/editor/preview-panel/asset-detail-editor.tsx`**
    - ç§»é™¤ `getAssetType()` è°ƒç”¨
    - ä½¿ç”¨æ–°çš„ `getAssetTagValues()` API

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»

**æ³¨æ„**: åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå‰ï¼Œéœ€è¦æ‰§è¡Œæ•°æ®åº“è¿ç§»ã€‚

è¿ç§»ç­–ç•¥ï¼š
```sql
-- 1. æ·»åŠ æ–°åˆ—
ALTER TABLE asset_tag ADD COLUMN new_tag_value TEXT;

-- 2. è¿ç§»æ•°æ®
UPDATE asset_tag 
SET new_tag_value = CASE 
  WHEN tag_type = 'type' AND tag_value = 'character' THEN 'è§’è‰²'
  WHEN tag_type = 'type' AND tag_value = 'scene' THEN 'åœºæ™¯'
  WHEN tag_type = 'type' AND tag_value = 'prop' THEN 'é“å…·'
  ELSE tag_value
END;

-- 3. åˆ é™¤æ—§åˆ—
ALTER TABLE asset_tag DROP COLUMN tag_type;
ALTER TABLE asset_tag DROP COLUMN tag_value;

-- 4. é‡å‘½åæ–°åˆ—
ALTER TABLE asset_tag RENAME COLUMN new_tag_value TO tag_value;

-- 5. æ·»åŠ çº¦æŸå’Œç´¢å¼•
ALTER TABLE asset_tag ALTER COLUMN tag_value SET NOT NULL;
CREATE INDEX idx_asset_tag_value ON asset_tag(tag_value);
```

## âœ… å‘åå…¼å®¹

- ç°æœ‰æ•°æ®ä¼šè‡ªåŠ¨è¿ç§»
- `type:character` â†’ `è§’è‰²`
- `type:scene` â†’ `åœºæ™¯`
- `type:prop` â†’ `é“å…·`
- å…¶ä»–è‡ªå®šä¹‰æ ‡ç­¾ä¿ç•™åŸå€¼

## ğŸ¨ UIæ”¹è¿›

### æ ‡ç­¾è¾“å…¥
- ä½¿ç”¨ Combobox ç»„ä»¶
- è‡ªåŠ¨æ˜¾ç¤ºé¢„è®¾æ ‡ç­¾å»ºè®®
- æ”¯æŒæœç´¢è¿‡æ»¤
- æ”¯æŒè¾“å…¥åˆ›å»ºæ–°æ ‡ç­¾

### æ ‡ç­¾ç­›é€‰
- é¢„è®¾æ ‡ç­¾ç½®é¡¶
- è‡ªå®šä¹‰æ ‡ç­¾æŒ‰å­—æ¯æ’åº
- å·²é€‰æ ‡ç­¾ç”¨ä¸åŒé¢œè‰²å¾½ç« æ ‡è¯†

### æ ‡ç­¾å±•ç¤º
- é¢„è®¾æ ‡ç­¾: ä¸»é¢˜è‰² (`variant="default"`)
- è‡ªå®šä¹‰æ ‡ç­¾: æ¬¡è¦è‰² (`variant="secondary"`)

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### æ·»åŠ æ ‡ç­¾
```typescript
// æ·»åŠ é¢„è®¾æ ‡ç­¾
await addAssetTag({
  assetId: "asset-id",
  tagValue: "è§’è‰²"
});

// æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
await addAssetTag({
  assetId: "asset-id",
  tagValue: "ä¸»è§’"
});
```

### ç­›é€‰æ ‡ç­¾
```typescript
// æŒ‰æ ‡ç­¾ç­›é€‰ç´ æ
const result = await queryAssets({
  projectId: "project-id",
  tagFilters: ["è§’è‰²", "ä¸»è§’"]
});
```

### æ£€æŸ¥æ ‡ç­¾
```typescript
import { hasAssetTag } from "@/types/asset";

// æ£€æŸ¥ç´ ææ˜¯å¦æœ‰æŸä¸ªæ ‡ç­¾
if (hasAssetTag(asset, "è§’è‰²")) {
  // ...
}
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **ä»£ç éƒ¨ç½²**
   - åˆå¹¶ä»£ç åˆ°ä¸»åˆ†æ”¯
   - éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

2. **æ•°æ®åº“è¿ç§»**
   - åœ¨ä½å³°æœŸæ‰§è¡Œè¿ç§»SQL
   - éªŒè¯æ•°æ®å®Œæ•´æ€§

3. **éªŒè¯æµ‹è¯•**
   - æµ‹è¯•æ ‡ç­¾æ·»åŠ åŠŸèƒ½
   - æµ‹è¯•æ ‡ç­¾ç­›é€‰åŠŸèƒ½
   - æµ‹è¯•ç´ æä¸Šä¼ 
   - æµ‹è¯•ç´ æç”Ÿæˆ

## ğŸ” æµ‹è¯•æ¸…å•

- [x] æ–°å»ºç´ æå¹¶æ·»åŠ é¢„è®¾æ ‡ç­¾
- [x] æ–°å»ºç´ æå¹¶æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
- [x] åŒæ—¶æ·»åŠ é¢„è®¾å’Œè‡ªå®šä¹‰æ ‡ç­¾
- [x] æŒ‰æ ‡ç­¾ç­›é€‰ç´ æ
- [x] åˆ é™¤æ ‡ç­¾
- [x] ä¸Šä¼ ç´ æè‡ªåŠ¨æ·»åŠ ç±»å‹æ ‡ç­¾
- [x] AIç”Ÿæˆç´ æè‡ªåŠ¨æ·»åŠ ç±»å‹æ ‡ç­¾
- [x] ç´ æè¯¦æƒ…æ­£ç¡®æ˜¾ç¤ºæ ‡ç­¾
- [x] æ ‡ç­¾ç­›é€‰å™¨æ­£ç¡®åˆ†ç»„æ˜¾ç¤º

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä¸è¦æ‰‹åŠ¨åˆ é™¤è¿ç§»SQL**ï¼šä¿ç•™è¿ç§»æ–‡ä»¶ä»¥ä¾¿å°†æ¥å‚è€ƒ
2. **æ ‡ç­¾å€¼å¤§å°å†™æ•æ„Ÿ**ï¼šç¡®ä¿ä½¿ç”¨ç»Ÿä¸€çš„æ ‡ç­¾å€¼ï¼ˆå»ºè®®ä½¿ç”¨ä¸­æ–‡é¢„è®¾ï¼‰
3. **é¢„è®¾æ ‡ç­¾å›ºå®š**ï¼šå¦‚éœ€ä¿®æ”¹é¢„è®¾æ ‡ç­¾ï¼Œéœ€æ›´æ–° `src/lib/constants/asset-tags.ts`

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ç®€åŒ–ä½¿æ ‡ç­¾ç³»ç»Ÿæ›´åŠ ç›´è§‚å’Œçµæ´»ï¼š
- âœ… æ•°æ®ç»“æ„æ›´ç®€å•
- âœ… ç”¨æˆ·ä½“éªŒæ›´å‹å¥½
- âœ… ä»£ç ç»´æŠ¤æ›´å®¹æ˜“
- âœ… å®Œå…¨å‘åå…¼å®¹

æ‰€æœ‰åŠŸèƒ½å·²æµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

