# 父子任务展示功能 - 测试指南

## 测试环境准备

1. 确保项目运行正常
2. 登录到系统
3. 打开一个项目的编辑器页面

## 测试场景

### 场景 1：分镜提取任务（父子任务）

**操作步骤：**
1. 在编辑器中，点击「分镜」标签
2. 点击「自动分镜」按钮，选择一个剧集
3. 启动分镜提取任务

**预期结果：**

后台任务面板应显示：

```
┌─────────────────────────────────────┐
│ 📹 分镜提取             [2/2]  🔄 处理中│
│   点击箭头展开查看子任务             │
└─────────────────────────────────────┘
```

点击展开后：

```
┌─────────────────────────────────────┐
│ ▼ 📹 分镜提取           [2/2]  🔄 处理中│
│   ├─────────────────────────────────│
│   │ 📹 基础分镜提取        ✅ 已完成  │
│   │   进度：100%                     │
│   └─────────────────────────────────│
│   │ 👥 角色场景匹配        🔄 处理中  │
│   │   进度：45%                      │
│   │   正在匹配角色信息...             │
└─────────────────────────────────────┘
```

**验证点：**
- ✅ 父任务显示总体状态和子任务计数
- ✅ 可以展开/折叠查看子任务
- ✅ 子任务有视觉缩进和左边框
- ✅ 子任务状态独立显示
- ✅ 父任务状态根据子任务动态更新

### 场景 2：批量视频生成任务

**操作步骤：**
1. 在时间轴选中多个分镜（例如 5 个）
2. 点击「批量生成视频」按钮

**预期结果：**

后台任务面板应显示：

```
┌─────────────────────────────────────┐
│ ▼ 🎬 批量视频生成       [2/5]  🔄 处理中│
│   ├─────────────────────────────────│
│   │ 🎬 单镜视频生成 #1     ✅ 已完成  │
│   └─────────────────────────────────│
│   │ 🎬 单镜视频生成 #2     ✅ 已完成  │
│   └─────────────────────────────────│
│   │ 🎬 单镜视频生成 #3     🔄 处理中  │
│   │   进度：60%                      │
│   └─────────────────────────────────│
│   │ 🎬 单镜视频生成 #4     ⏰ 等待中  │
│   └─────────────────────────────────│
│   │ 🎬 单镜视频生成 #5     ⏰ 等待中  │
└─────────────────────────────────────┘
```

**验证点：**
- ✅ 显示批量任务的进度（2/5）
- ✅ 每个子任务显示独立的状态
- ✅ 可以单独取消某个子任务
- ✅ 父任务状态反映所有子任务的整体情况

### 场景 3：嵌套层级测试

如果将来有多层嵌套任务，应该支持：

```
┌─────────────────────────────────────┐
│ ▼ 🎬 成片制作                [1/3]   │
│   ├─────────────────────────────────│
│   │ ▼ 🎬 批量视频生成   [2/3]  🔄   │
│   │   ├─────────────────────────────│
│   │   │ 🎬 单镜视频 #1    ✅        │
│   │   └─────────────────────────────│
│   │   │ 🎬 单镜视频 #2    🔄        │
│   │   └─────────────────────────────│
│   │   │ 🎬 单镜视频 #3    ⏰        │
│   └─────────────────────────────────│
│   │ 🎵 语音合成            ⏰ 等待中 │
│   └─────────────────────────────────│
│   │ 🎞️ 最终导出            ⏰ 等待中 │
└─────────────────────────────────────┘
```

### 场景 4：状态同步测试

**操作步骤：**
1. 创建一个有子任务的父任务
2. 等待所有子任务完成

**预期结果：**
- 所有子任务完成后，父任务状态应变为「已完成」
- 如果有子任务失败，父任务状态应变为「失败」
- 如果取消父任务，所有子任务应该被取消

### 场景 5：历史任务查看

**操作步骤：**
1. 完成一些有子任务的父任务
2. 刷新页面
3. 打开后台任务面板

**预期结果：**
- 历史任务仍然保持父子关系
- 可以展开查看已完成任务的子任务
- 父子关系正确恢复

## 边界情况测试

### 1. 无子任务的任务
- 应该不显示展开/折叠按钮
- 应该不显示子任务计数

### 2. 父任务被删除
- 子任务应该级联删除（数据库约束）
- UI 应该正确更新

### 3. 大量子任务
- 测试 50+ 个子任务的显示性能
- 滚动应该流畅
- 展开/折叠应该响应快速

### 4. 实时更新
- 子任务状态变化时，父任务统计应实时更新
- SSE 推送应该正确处理父子关系

## 性能验证

### 渲染性能
```bash
# 检查组件渲染次数
# 使用 React DevTools Profiler

预期：
- 展开/折叠只重新渲染相关节点
- 状态更新不会导致整个树重新渲染
```

### 内存占用
```bash
# 创建 100 个任务（50 个父任务，每个 2 个子任务）
# 使用浏览器的内存分析工具

预期：
- 内存占用在合理范围内（< 50MB）
- 没有明显的内存泄漏
```

## 自动化测试建议

### 单元测试（task-tree.ts）

```typescript
import { buildTaskTree, getNodeOverallStatus } from './task-tree';

describe('buildTaskTree', () => {
  it('should build tree from flat job list', () => {
    const jobs = [
      { id: '1', type: 'parent', parentJobId: null },
      { id: '2', type: 'child', parentJobId: '1' },
    ];
    const tree = buildTaskTree(jobs);
    expect(tree).toHaveLength(1);
    expect(tree[0].children).toHaveLength(1);
  });
  
  it('should handle orphaned children', () => {
    const jobs = [
      { id: '2', type: 'child', parentJobId: '999' }, // 父任务不存在
    ];
    const tree = buildTaskTree(jobs);
    expect(tree).toHaveLength(1); // 应该作为根节点
  });
});

describe('getNodeOverallStatus', () => {
  it('should calculate overall status correctly', () => {
    const node = {
      job: { id: '1', status: 'processing' },
      children: [
        { job: { id: '2', status: 'completed' }, children: [] },
        { job: { id: '3', status: 'processing' }, children: [] },
      ],
    };
    const status = getNodeOverallStatus(node);
    expect(status.activeCount).toBe(2); // 父 + 1个子任务
    expect(status.totalCount).toBe(3);
  });
});
```

### 集成测试

```typescript
describe('BackgroundTasks Component', () => {
  it('should render task tree correctly', () => {
    // 渲染组件
    // 模拟有父子任务的数据
    // 验证 DOM 结构
  });
  
  it('should expand/collapse nodes', () => {
    // 点击展开按钮
    // 验证子任务显示/隐藏
  });
  
  it('should update parent status when child status changes', () => {
    // 模拟子任务状态变化
    // 验证父任务状态更新
  });
});
```

## 已知问题

### Issue #1: 深度嵌套性能
- **描述**：超过 3 层嵌套时可能有性能问题
- **影响**：当前系统最多 2 层，暂无影响
- **优化方案**：可以考虑虚拟滚动

### Issue #2: 实时同步延迟
- **描述**：SSE 更新可能有 1-2 秒延迟
- **影响**：用户体验略受影响
- **优化方案**：考虑添加乐观更新

## 回归测试清单

在未来更新时，确保以下功能仍然正常：

- [ ] 单个任务的取消/重试功能
- [ ] 任务进度条显示
- [ ] 错误消息显示
- [ ] 任务详情获取（project、episode 信息）
- [ ] 查看结果功能（分镜、角色、场景）
- [ ] SSE 实时更新
- [ ] 历史任务加载
- [ ] 移动端适配

## 用户反馈收集

推荐的用户反馈问题：

1. 父子任务关系是否清晰？
2. 展开/折叠操作是否流畅？
3. 子任务统计信息是否有用？
4. 视觉层级区分是否明显？
5. 是否需要批量操作功能（展开全部等）？

